# 应用插件文档

## 概述

本文档说明应用插件的概念、格式和使用方式。应用插件是隐身盾项目中引入的新概念，用于统一管理一个应用所需的所有代码插件配置。

## 核心概念

### 代码插件 vs 应用插件

#### 代码插件（插件引擎）

- **定义**：网关框架改造自 APISIX，沿用其插件机制。代码插件指的是单个 Lua 文件模块（如 `exposure_login.lua`、`passwd_restriction.lua` 等）
- **位置**：位于 `shield/plugins/` 目录下
- **作用**：实现具体的业务逻辑（如登录处理、弱密码检测、暴力破解防护等）
- **配置**：每个代码插件接收一份 JSON 配置对象（`conf`），用于控制插件的行为

**示例**：
- `shield/plugins/exposure_login.lua` - 登录处理代码插件
- `shield/plugins/passwd_restriction.lua` - 弱密码检测代码插件
- `shield/plugins/passwd_bruteforce.lua` - 暴力破解防护代码插件

#### 应用插件

- **定义**：将一个应用用到的所有代码插件的JSON配置集合称为应用插件
- **作用**：统一管理一个应用的所有代码插件配置，便于配置管理和 UI 化操作
- **格式**：包含 `desc`、`user_configures`、`gw_configures` 三个主要部分
- **示例**：`grafana插件.json` 就是 Grafana 应用的应用插件

### 关系说明

```
应用插件 (grafana插件.json)
    │
    ├─ desc (应用插件元信息)
    │
    ├─ user_configures (UI 配置项映射)
    │   └─ 通过 json_path 映射到 gw_configures
    │
    └─ gw_configures (实际下发给网关的配置)
        ├─ plugins (主插件组)
        ├─ sub_routes (子路由)
        └─ plugin_confs (插件配置)
            │
            └─ 下发给各个代码插件
                ├─ exposure_login.lua ← exposure_login 配置
                ├─ passwd_restriction.lua ← passwd_restriction 配置
                └─ ...
```

## 应用插件格式

应用插件是一个 JSON 文件，包含以下三个主要部分：

### 1. desc - 应用插件元信息

描述应用插件的基本信息，用于标识和管理。

```json
{
  "desc": {
    "plugin_name": "grafana插件",
    "plugin_for_app_name": "grafana",
    "plugin_for_app_version": "V1",
    "plugin_version": "1.0.0",
    "plugin_need_engine_version": "1.0",
    "plugin_author": "TigerSec",
    "plugin_description": "grafana插件",
    "plugin_last_updated": "2025-12-18"
  }
}
```

**字段说明**：

| 字段 | 类型 | 说明 |
|------|------|------|
| `plugin_name` | string | 应用插件名称 |
| `plugin_for_app_name` | string | 目标应用名称 |
| `plugin_for_app_version` | string | 目标应用版本 |
| `plugin_version` | string | 应用插件版本 |
| `plugin_need_engine_version` | string | 所需插件引擎版本 |
| `plugin_author` | string | 作者 |
| `plugin_description` | string | 描述信息 |
| `plugin_last_updated` | string | 最后更新时间 |

### 2. gw_configures - 网关配置

实际下发给网关的配置，包含所有代码插件的配置。这部分配置会被网关直接使用，传递给对应的代码插件。

```json
{
  "gw_configures": {
    "plugins": [...],           // 主插件组
    "sub_routes": [...],        // 子路由配置
    "plugin_groups": {...},     // 插件组定义
    "plugin_confs": {...}       // 插件配置
  }
}
```

**结构说明**：

- **plugins**：主插件组，定义应用主路由的插件列表
- **sub_routes**：子路由配置，为特殊接口（如登录接口、登录页面）配置不同的插件组
- **plugin_groups**：插件组定义，可被 `sub_routes[].plugin_group_id` 或应用顶层的 `plugin_group_id` 引用，便于复用一组插件
- **plugin_confs**：插件配置，定义各个代码插件的具体配置项

**示例**：

```json
{
  "gw_configures": {
    "plugins": [
      "redirect",
      "client_ip",
      "uri_blocker",
      {
        "name": "exposure_auth",
        "conf": {
          "reject_unauthed": true,
          "log_unauthed": true
        }
      }
    ],
    "sub_routes": [
      {
        "name": "登录接口",
        "plugins": [...],
        "routes": [...]
      }
    ],
    "plugin_confs": {
      "exposure_session": {
        "key_name": "cookie_WISID"
      }
    }
  }
}
```

### 3. user_configures - UI 配置项映射

定义哪些 `gw_configures` 下的配置项可以通过 UI 进行配置。通过 JSON Path 指定配置项的位置，用户通过 UI 操作填写配置值，系统会自动转义并更新到 `gw_configures` 对应的位置。

```json
{
  "user_configures": [
    {
      "lable": "拒绝未认证请求",
      "json_path": "gw_configures.plugins[7].conf.reject_unauthed",
      "type": "bool",
      "description": "除了白名单之外的未认证请求，是否拒绝"
    },
    {
      "lable": "弱密码登录请求",
      "json_path": "gw_configures.sub_routes[0].plugins[6].conf.action",
      "type": "select",
      "value_type": "text",
      "description": "对于检测为弱密码的登录请求的处理方式",
      "options": [
        {
          "label": "放行",
          "value": "allow"
        },
        {
          "label": "阻断",
          "value": "block"
        }
      ]
    }
  ]
}
```

**字段说明**：

| 字段 | 类型 | 必需 | 说明 |
|------|------|------|------|
| `lable` | string | 是 | UI 显示的配置项标签 |
| `json_path` | string | 是 | JSON Path 路径，指向 `gw_configures` 中的配置项 |
| `type` | string | 是 | 配置项类型：`bool`、`int`、`string`、`select` 等 |
| `description` | string | 是 | 配置项说明 |
| `value_type` | string | 否 | 值类型（当 `type` 为 `select` 时使用） |
| `options` | array | 否 | 选项列表（当 `type` 为 `select` 时使用） |

**JSON Path 说明**：

JSON Path 用于定位 `gw_configures` 中的配置项，支持以下语法：

- `gw_configures.plugins[7].conf.reject_unauthed` - 访问数组索引为 7 的插件配置
- `gw_configures.sub_routes[0].plugins[6].conf.action` - 访问子路由中插件的配置
- `gw_configures.plugin_confs.exposure_session.key_name` - 访问插件配置中的字段

## 工作流程

### UI 配置流程

```
1. 用户打开应用插件配置界面
   │
   ├─ 系统读取应用插件 JSON 文件
   │
   ├─ 解析 user_configures，生成 UI 表单
   │   └─ 根据 json_path 从 gw_configures 读取当前值
   │
   ├─ 用户在 UI 中填写配置项
   │
   └─ 系统根据 json_path 更新 gw_configures
       └─ 将用户输入的值写入对应的配置项位置
```

### 配置下发流程

```
1. 系统读取应用插件 JSON 文件
   │
   ├─ 提取 gw_configures 部分
   │
   ├─ 应用 user_configures 的覆盖值（如果有）
   │
   └─ 下发给网关
       │
       └─ 网关解析配置，传递给对应的代码插件
           ├─ exposure_login.lua ← exposure_login 配置
           ├─ passwd_restriction.lua ← passwd_restriction 配置
           └─ ...
```

## 完整示例

以下是一个完整的应用插件示例（Grafana 应用插件）：

```json
{
  "desc": {
    "plugin_name": "grafana插件",
    "plugin_for_app_name": "grafana",
    "plugin_version": "1.0.0"
  },
  "user_configures": [
    {
      "lable": "拒绝未认证请求",
      "json_path": "gw_configures.plugins[7].conf.reject_unauthed",
      "type": "bool",
      "description": "除了白名单之外的未认证请求，是否拒绝"
    },
    {
      "lable": "弱密码登录请求",
      "json_path": "gw_configures.sub_routes[0].plugins[6].conf.action",
      "type": "select",
      "value_type": "text",
      "description": "对于检测为弱密码的登录请求的处理方式",
      "options": [
        {"label": "放行", "value": "allow"},
        {"label": "阻断", "value": "block"}
      ]
    }
  ],
  "gw_configures": {
    "plugins": [
      "redirect",
      "client_ip",
      {
        "name": "exposure_auth",
        "conf": {
          "reject_unauthed": true,
          "log_unauthed": true
        }
      }
    ],
    "sub_routes": [
      {
        "name": "登录接口",
        "plugins": [
          {
            "name": "passwd_restriction",
            "conf": {
              "action": "block"
            }
          }
        ],
        "routes": [
          {
            "uri": "/login",
            "methods": ["POST"]
          }
        ]
      }
    ],
    "plugin_groups": {
      // 可选：在这里定义可复用的插件组，并通过 plugin_group_id 引用
    },
    "plugin_confs": {
      "exposure_session": {
        "key_name": "cookie_WISID"
      }
    }
  }
}
```

## 配置项映射示例

### 示例 1：布尔类型配置

**user_configures**：
```json
{
  "lable": "拒绝未认证请求",
  "json_path": "gw_configures.plugins[7].conf.reject_unauthed",
  "type": "bool",
  "description": "除了白名单之外的未认证请求，是否拒绝"
}
```

**映射关系**：
- UI 显示：复选框，标签为"拒绝未认证请求"
- 用户操作：勾选/取消勾选
- 更新位置：`gw_configures.plugins[7].conf.reject_unauthed`
- 值：`true` 或 `false`

### 示例 2：选择类型配置

**user_configures**：
```json
{
  "lable": "弱密码登录请求",
  "json_path": "gw_configures.sub_routes[0].plugins[6].conf.action",
  "type": "select",
  "value_type": "text",
  "description": "对于检测为弱密码的登录请求的处理方式",
  "options": [
    {"label": "放行", "value": "allow"},
    {"label": "阻断", "value": "block"}
  ]
}
```

**映射关系**：
- UI 显示：下拉选择框，标签为"弱密码登录请求"
- 用户操作：选择"放行"或"阻断"
- 更新位置：`gw_configures.sub_routes[0].plugins[6].conf.action`
- 值：`"allow"` 或 `"block"`

### 示例 3：整数类型配置

**user_configures**：
```json
{
  "lable": "暴力破解单位时间次数",
  "json_path": "gw_configures.sub_routes[0].plugins[7].conf.count",
  "type": "int",
  "description": "时间窗口内允许的最大失败次数"
}
```

**映射关系**：
- UI 显示：数字输入框，标签为"暴力破解单位时间次数"
- 用户操作：输入数字（如 `4`）
- 更新位置：`gw_configures.sub_routes[0].plugins[7].conf.count`
- 值：`4`（整数）

## 优势

### 1. 配置统一管理

- 一个应用的所有代码插件配置集中在一个文件中
- 便于版本控制和配置备份
- 配置结构清晰，易于理解和维护

### 2. UI 化配置

- 通过 `user_configures` 定义可配置项
- 用户无需直接编辑 JSON，通过 UI 操作即可配置
- 降低配置错误风险，提升用户体验

### 3. 灵活扩展

- 可以随时添加新的 `user_configures` 配置项
- 支持多种配置类型（bool、int、string、select 等）
- 通过 JSON Path 精确定位配置项

### 4. 向后兼容

- `gw_configures` 保持与原有配置格式一致
- 代码插件无需修改，继续使用原有配置结构
- 平滑过渡，不影响现有功能

## JSON Path 详解

### 路径语法

JSON Path 使用点号（`.`）访问对象属性，使用方括号（`[]`）访问数组元素：

- `gw_configures.plugins[7].conf.reject_unauthed` - 访问主插件组中第 8 个插件（索引从 0 开始）的配置
- `gw_configures.sub_routes[0].plugins[6].conf.action` - 访问第一个子路由中第 7 个插件的配置
- `gw_configures.plugin_confs.exposure_session.key_name` - 访问插件配置中的字段
- `gw_configures.sub_routes[0].plugins[8].conf.inspect_content.reject` - 访问嵌套配置项

### 路径示例

| 配置项位置 | JSON Path |
|-----------|-----------|
| 主插件组第 8 个插件的 `reject_unauthed` | `gw_configures.plugins[7].conf.reject_unauthed` |
| 登录接口子路由第 6 个插件的 `action` | `gw_configures.sub_routes[0].plugins[5].conf.action` |
| 登录接口子路由第 7 个插件的 `block_login` | `gw_configures.sub_routes[0].plugins[6].conf.block_login` |
| 登录接口子路由第 8 个插件的 `inspect_content.reject` | `gw_configures.sub_routes[0].plugins[7].conf.inspect_content.reject` |
| `exposure_session` 插件的 `key_name` | `gw_configures.plugin_confs.exposure_session.key_name` |

## 配置类型说明

### bool 类型

用于布尔值配置项，UI 显示为复选框。

```json
{
  "lable": "拒绝未认证请求",
  "json_path": "gw_configures.plugins[7].conf.reject_unauthed",
  "type": "bool",
  "description": "除了白名单之外的未认证请求，是否拒绝"
}
```

**UI 表现**：复选框，勾选为 `true`，取消勾选为 `false`

### int 类型

用于整数配置项，UI 显示为数字输入框。

```json
{
  "lable": "暴力破解单位时间次数",
  "json_path": "gw_configures.sub_routes[0].plugins[7].conf.count",
  "type": "int",
  "description": "时间窗口内允许的最大失败次数"
}
```

**UI 表现**：数字输入框，用户输入整数

### string 类型

用于字符串配置项，UI 显示为文本输入框。

```json
{
  "lable": "响应消息",
  "json_path": "gw_configures.plugins[7].conf.response_msg",
  "type": "string",
  "description": "认证失败时返回的消息"
}
```

**UI 表现**：文本输入框，用户输入字符串

### select 类型

用于选择类型配置项，UI 显示为下拉选择框。

```json
{
  "lable": "弱密码登录请求",
  "json_path": "gw_configures.sub_routes[0].plugins[6].conf.action",
  "type": "select",
  "value_type": "text",
  "description": "对于检测为弱密码的登录请求的处理方式",
  "options": [
    {"label": "放行", "value": "allow"},
    {"label": "阻断", "value": "block"}
  ]
}
```

**字段说明**：
- `value_type`：值类型，通常为 `"text"` 表示字符串值
- `options`：选项列表，每个选项包含 `label`（显示文本）和 `value`（实际值）

**UI 表现**：下拉选择框，用户从选项中选择，系统写入对应的 `value`

## 注意事项

1. **JSON Path 准确性**：`user_configures` 中的 `json_path` 必须准确指向 `gw_configures` 中的配置项，否则配置更新会失败

2. **数组索引**：使用数组索引（如 `plugins[7]`）时，需要确保索引位置正确，插件顺序变化时索引也需要相应调整

3. **配置类型匹配**：`user_configures` 中定义的 `type` 必须与 `gw_configures` 中对应配置项的类型匹配

4. **默认值**：如果 `user_configures` 中未配置某个配置项，则使用 `gw_configures` 中的默认值

5. **配置验证**：系统应该验证用户通过 UI 输入的配置值是否符合代码插件的要求

6. **嵌套配置**：对于嵌套配置项（如 `inspect_content.reject`），JSON Path 使用点号连接路径

7. **配置覆盖**：用户通过 UI 修改配置后，系统会将新值写入 `gw_configures` 对应位置，覆盖原有值

8. **配置持久化**：修改后的 `gw_configures` 需要保存到应用插件 JSON 文件中，或通过配置管理系统持久化

## 相关文档

- [5分钟编写应用插件.md](5分钟编写应用插件.md) - 了解如何编写应用插件（配置代码插件）
- [业务流程架构图.md](业务流程架构图.md) - 了解整体架构和插件执行流程
- [exposure_login.md](exposure_login.md) - 了解登录插件的配置
- [passwd_restriction.md](passwd_restriction.md) - 了解弱密码检测插件的配置
- [passwd_bruteforce.md](passwd_bruteforce.md) - 了解暴力破解防护插件的配置
