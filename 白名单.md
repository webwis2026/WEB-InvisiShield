# 白名单配置文档

## 概述

白名单用于配置不需要经过认证检测的URL路径。平台支持两种白名单配置方式：

- **子路由白名单**：通过子路由配置，使用基数树匹配，性能更高，支持 HTTP 方法和条件匹配
- **正则白名单**：通过 `uri_bypass` 插件配置，使用正则表达式匹配，灵活性更高

## 子路由白名单

子路由白名单通过子路由配置自己的插件组，匹配的请求将使用子路由的插件组而不是主路由的插件组。子路由可以配置空插件数组（跳过所有插件），也可以配置部分插件（如防护类插件），从而跳过主路由中的某些插件（如认证插件exposure_auth, wis_auth）。

### 工作原理

```
请求到达
    ↓
子路由匹配（基数树）
    ↓
匹配成功 → 使用子路由插件组（可能为空或包含部分插件）
    ↓
匹配失败 → 使用主路由插件组
```

### 配置方式

在应用的 `sub_routes` 中配置白名单子路由：

```json
{
  "sub_routes": [
    {
      "name": "白名单接口",
      "plugins": [],
      "routes": [
        {
          "uri": "/health",
          "methods": ["GET"]
        },
        {
          "uri": "/metrics",
          "methods": ["GET"]
        },
        {
          "uris": ["/favicon.ico", "/robots.txt"]
        }
      ]
    }
  ]
}
```

### 配置字段说明

| 字段 | 类型 | 必需 | 说明 |
|------|------|------|------|
| `name` | string | 是 | 子路由名称，用于标识和日志 |
| `plugins` | array | 是 | 插件列表，可以为空数组 `[]`（跳过所有插件），也可以包含部分插件（如 `uri_blocker`、`ip_restriction` 等防护类插件） |
| `plugin_group_id` | string | 二选一 | 引用 `plugin_groups` 中定义的插件组（与 `plugins` 二选一） |
| `routes` | array | 是 | 路由匹配规则数组 |

**注意**：`plugins` 和 `plugin_group_id` 必须配置其中之一。

路由匹配规则支持以下字段：

| 字段 | 类型 | 必需 | 说明 |
|------|------|------|------|
| `uri` | string | 二选一 | 匹配的 URI 路径 |
| `uris` | array | 二选一 | 匹配的多个 URI 路径 |
| `methods` | array | 否 | 匹配的 HTTP 方法，如 `["GET", "POST"]` |
| `vars` | array | 否 | 额外的匹配条件，使用 lua-resty-expr 语法 |

### URI 匹配规则

子路由使用 `resty.radixtree` 进行 URI 匹配，支持以下模式：

#### 精确匹配

```json
{
  "uri": "/api/login"
}
```

仅匹配 `/api/login`。

#### 前缀匹配

```json
{
  "uri": "/api/*"
}
```

匹配 `/api/` 下的所有路径，如 `/api/login`、`/api/user/info` 等。

#### 多路径匹配

```json
{
  "uris": ["/api/login", "/api/auth", "/login"]
}
```

匹配多个 URI 路径。

### 方法匹配

通过 `methods` 字段指定允许的 HTTP 方法：

```json
{
  "uri": "/api/login",
  "methods": ["POST"]
}
```

- 不配置 `methods` 时，匹配所有 HTTP 方法
- 配置后仅匹配指定的方法

支持的方法：`GET`、`POST`、`PUT`、`DELETE`、`PATCH`、`HEAD`、`OPTIONS`

### 条件匹配（vars）

使用 `vars` 字段添加额外的匹配条件，表达式语法参考 [条件表达式.md](条件表达式.md)。

**注意**：`vars` 中使用系统变量必须使用 `$变量名` 格式引用。

#### 根据查询参数匹配

```json
{
  "uri": "/api/login",
  "methods": ["POST"],
  "vars": [
    ["$arg_type", "==", "mobile"]
  ]
}
```

仅匹配 `/api/login?type=mobile` 的 POST 请求。

#### 根据请求头匹配

```json
{
  "uri": "/api/login",
  "vars": [
    ["$http_x_client_type", "==", "app"]
  ]
}
```

仅匹配请求头 `X-Client-Type: app` 的请求。

#### 多条件组合

```json
{
  "uri": "/api/login",
  "methods": ["POST"],
  "vars": ["AND",
    ["$arg_type", "==", "mobile"],
    ["$http_user_agent", "~~", "Android"]
  ]
}
```

匹配移动端 Android 设备的登录请求。

### 使用示例

#### 示例 1：完全跳过所有插件（空数组）

```json
{
  "sub_routes": [
    {
      "name": "健康检查接口",
      "plugins": [],
      "routes": [
        {
          "uri": "/health",
          "methods": ["GET"]
        },
        {
          "uri": "/healthz",
          "methods": ["GET"]
        },
        {
          "uri": "/metrics",
          "methods": ["GET"]
        },
        {
          "uri": "/actuator/health",
          "methods": ["GET"]
        }
      ]
    }
  ]
}
```

#### 示例 2：跳过认证但保留防护插件

```json
{
  "sub_routes": [
    {
      "name": "公开API（保留防护）",
      "plugins": [
        "redirect",
        "client_ip",
        "uri_blocker",
        "ip_restriction"
      ],
      "routes": [
        {
          "uri": "/api/public/*"
        },
        {
          "uri": "/api/v1/open/*"
        }
      ]
    }
  ]
}
```

上述配置中，匹配的请求会执行防护类插件（`uri_blocker`、`ip_restriction`），但会跳过主路由中的认证插件（如 `exposure_auth`）。

#### 示例 3：静态资源白名单（完全跳过）

```json
{
  "sub_routes": [
    {
      "name": "静态资源",
      "plugins": [],
      "routes": [
        {
          "uri": "/static/*"
        },
        {
          "uri": "/assets/*"
        },
        {
          "uri": "/public/*",
          "vars": [
            ["$uri_ext", "in", ["css", "js", "png", "jpg", "gif", "ico", "svg", "woff", "woff2"]]
          ]
        },
        {
          "uris": ["/favicon.ico", "/robots.txt"]
        }
      ]
    }
  ]
}
```

上述配置中，`/public/*` 路径下只有文件扩展名在指定列表中的请求才会匹配（如 `/public/style.css`、`/public/app.js` 等）。

#### 示例 4：使用插件组引用

```json
{
  "sub_routes": [
    {
      "name": "白名单接口",
      "plugin_group_id": "whitelist_plugins",
      "routes": [
        {
          "uri": "/api/public/*"
        }
      ]
    }
  ],
  "plugin_groups": {
    "whitelist_plugins": [
      "redirect",
      "client_ip",
      "uri_blocker"
    ]
  }
}
```

### 注意事项

1. **插件配置**：
   - 可以配置空数组 `plugins: []`，完全跳过所有插件
   - 也可以配置部分插件（如 `uri_blocker`、`ip_restriction` 等），只跳过主路由中的某些插件（如认证插件）
   - 子路由的插件组会完全替代主路由的插件组

2. **匹配优先级**：子路由优先于主路由匹配，匹配成功则使用子路由的插件组

3. **性能优势**：使用基数树匹配，性能高于正则匹配

4. **灵活匹配**：支持 HTTP 方法匹配和条件组合，比正则白名单更灵活

5. **路由缓存**：子路由使用 LRU 缓存（TTL 3600秒，最大 1024 条），配置更新后会自动刷新

6. **插件组引用**：可以使用 `plugin_group_id` 引用已定义的插件组，便于复用配置



## 正则白名单（uri_bypass）

正则白名单通过 `uri_bypass` 插件实现，基于正则表达式匹配 URI，通过插件执行顺序实现白名单效果。

### 工作原理

```
插件组执行顺序:
┌─────────────────────────────────────────────────────────────┐
│  uri_bypass → exposure_auth → 其他插件 → ...               │
└─────────────────────────────────────────────────────────────┘
         │
         ├── URI 匹配成功 → 返回 0 → 终止插件组执行（跳过后续认证）
         │
         └── URI 不匹配 → 继续执行 exposure_auth 等后续插件
```

**关键点**：

1. **插件顺序**：`uri_bypass` 必须配置在认证插件（如 `exposure_auth`）**之前**
2. **返回值机制**：匹配成功时返回 `0`，表示终止当前插件组内剩余插件的执行
3. **白名单效果**：通过跳过后续认证插件，实现白名单 URL 无需认证即可访问
4. **URI 匹配**：参与匹配的为 `var.uri`，不包含请求参数（query string）

### 配置方式

在插件组中配置 `uri_bypass` 插件，并确保其在认证插件之前：

```json
{
  "plugins": [
    "redirect",
    "client_ip",
    "uri_bypass",
    "exposure_auth",
    "app_logger"
  ]
}
```

上述配置中，如果请求 URI 匹配 `uri_bypass` 的规则，则 `exposure_auth` 和 `app_logger` 不会执行。

### 插件配置

`uri_bypass` 在文档中仅作为**基于 URI 的正则白名单插件**使用，配置通过 `filters` 完成：

#### filters 结构

`filters` 用于简单的 URI 正则白名单（不区分 IP），配置形式为「正则字符串数组」：

```json
{
  "name": "uri_bypass",
  "conf": {
    "filters": [
      "^/health$",
      "^/metrics$",
      "^/static/.*",
      "\\\\.(css|js|png|jpg|gif|ico)$"
    ]
  }
}
```

**字段说明：**

| 字段 | 类型 | 必需 | 说明 |
|------|------|------|------|
| `filters` | array | 否 | URI 正则表达式数组（PCRE），仅按 URI 匹配，不做 IP / 地域限制 |

### 正则语法

使用 PCRE（Perl Compatible Regular Expressions）语法。

常用模式：
- `^/path$` - 精确匹配
- `^/path/.*` - 前缀匹配
- `^/path/[0-9]+$` - 带参数匹配
- `\\.(css|js|png|jpg)$` - 文件扩展名匹配

### 使用示例

#### 示例 1：静态资源白名单（使用 filters）

```json
{
  "name": "uri_bypass",
  "conf": {
    "filters": [
      "^/static/.*",
      "^/assets/.*",
      "\\\\.(css|js|png|jpg|gif|ico|svg|woff|woff2)$"
    ]
  }
}
```

#### 示例 2：健康检查和监控接口（使用 filters）

```json
{
  "name": "uri_bypass",
  "conf": {
    "filters": [
      "^/health$",
      "^/healthz$",
      "^/ready$",
      "^/metrics$",
      "^/actuator/health$"
    ]
  }
}
```

#### 示例 3：公开 API 接口（使用 filters）

```json
{
  "name": "uri_bypass",
  "conf": {
    "filters": [
      "^/api/public/.*",
      "^/api/v1/open/.*"
    ]
  }
}
```

### 插件执行终止

匹配白名单成功后，插件返回 `0`，这会终止插件组内剩余插件的执行。

**返回值说明**：
- 返回 `nil` / 无返回值：继续执行下一个插件
- 返回 `0`：终止插件组执行，直接放行请求
- 返回其他状态码（如 `302`、`403`）：终止并返回该 HTTP 状态码

### 注意事项

1. **插件顺序**：必须将 `uri_bypass` 配置在认证插件（如 `exposure_auth`）**之前**，否则白名单不生效

2. **正则性能**：复杂的正则表达式会影响性能，建议使用简单的模式

3. **规则顺序**：`filters` 按配置顺序依次匹配，第一个匹配成功的规则生效

4. **缓存**：匹配器会被缓存，配置更新后自动刷新

5. **调试**：可通过日志查看匹配结果，匹配成功会记录 `matched uri_bypass`

6. **URI 匹配**：参与匹配的为 `var.uri`，不包含请求参数（query string）



## 两种方式对比

| 特性 | 子路由白名单 | 正则白名单（uri_bypass） |
|------|------------|---------------------------|
| **匹配方式** | 基数树（radixtree） | 正则表达式 |
| **性能** | **更高**（基数树匹配） | 一般（正则匹配） |
| **配置复杂度** | 稍复杂 | **简单** |
| **HTTP 方法匹配** | **支持** | 不支持 |
| **条件组合** | **支持（vars）** | 不支持 |
| **正则灵活性** | 有限（前缀/参数匹配） | **高** |
| **适用场景** | 需要方法或条件匹配 | 需要复杂正则匹配（如扩展名） |

## 使用建议

### 推荐使用子路由白名单的场景

- 需要根据 HTTP 方法匹配（如只允许 GET 请求）
- 需要根据查询参数、请求头等条件匹配
- 需要精确控制匹配规则
- 对性能要求较高
- **需要跳过认证但保留防护插件**：可以配置部分插件（如 `uri_blocker`、`ip_restriction`），只跳过认证插件
- **需要完全跳过所有插件**：配置空数组 `plugins: []`

### 推荐使用正则白名单的场景

- 需要匹配文件扩展名（如 `.css`、`.js`、`.png`）
- 需要复杂的正则表达式匹配
- 配置简单，不需要方法或条件匹配
- **注意**：正则白名单会跳过后续所有插件，无法保留部分插件

### 同时使用两种方式

可以同时使用子路由白名单和正则白名单：

```json
{
  "sub_routes": [
    {
      "name": "健康检查",
      "plugins": [],
      "routes": [
        {
          "uri": "/health",
          "methods": ["GET"]
        }
      ]
    }
  ],
  "plugins": [
    "redirect",
    "client_ip",
    {
      "name": "uri_bypass",
      "conf": {
        "filters": [
          "\\\\.(css|js|png|jpg|gif|ico)$"
        ]
      }
    },
    "exposure_auth",
    "app_logger"
  ]
}
```

**建议**：
- 需要 HTTP 方法或条件匹配：使用子路由白名单
- 需要复杂正则匹配（如文件扩展名）：使用正则白名单

## 完整配置示例

### 示例：混合使用两种白名单方式

```json
{
  "sub_routes": [
    {
      "name": "健康检查接口",
      "plugins": [],
      "routes": [
        {
          "uri": "/health",
          "methods": ["GET"]
        },
        {
          "uri": "/metrics",
          "methods": ["GET"]
        }
      ]
    },
    {
      "name": "公开API（保留防护）",
      "plugins": [
        "redirect",
        "client_ip",
        "uri_blocker",
        "ip_restriction"
      ],
      "routes": [
        {
          "uri": "/api/public/*"
        }
      ]
    }
  ],
  "plugins": [
    "redirect",
    "client_ip",
    {
      "name": "uri_bypass",
      "conf": {
        "filters": [
          "^/static/.*",
          "^/assets/.*",
          "\\\\.(css|js|png|jpg|gif|ico|svg|woff|woff2)$"
        ]
      }
    },
    "exposure_auth",
    "app_logger"
  ]
}
```

上述配置中：
- `/health` 和 `/metrics` 的 GET 请求通过子路由白名单完全跳过所有插件
- `/api/public/*` 下的所有请求通过子路由白名单执行防护类插件（`uri_blocker`、`ip_restriction`），但跳过认证插件（`exposure_auth`）
- 静态资源（`/static/*`、`/assets/*` 和文件扩展名匹配）通过正则白名单跳过后续认证插件

