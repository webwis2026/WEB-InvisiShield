# 5åˆ†é’Ÿç¼–å†™åº”ç”¨æ’ä»¶ - é›¶æ”¹é€ å¼•æ“è§„åˆ™é…ç½®

æœ¬æ–‡æ¡£å¸®åŠ©æ‚¨å¿«é€Ÿé…ç½®Webéšèº«ç›¾æš´éœ²é¢æ”¶æ•›æ’ä»¶ï¼Œå¿«é€Ÿå®ç°äº’è”ç½‘æš´éœ²é¢æ”¶æ•›ã€‚

## ğŸ¯ é€‚ç”¨åœºæ™¯

**ä»€ä¹ˆæ—¶å€™ä½¿ç”¨é›¶æ”¹é€ å¼•æ“è§„åˆ™ï¼Ÿ**

- âœ… ä¼ä¸šå†…éƒ¨åº”ç”¨ï¼ˆOA/ERP/è´¢åŠ¡/CRMç­‰ï¼‰éœ€è¦æš´éœ²é¢æ”¶æ•›
- âœ… å¸Œæœ›åœ¨ä¸ä¿®æ”¹åº”ç”¨ä»£ç çš„æƒ…å†µä¸‹ï¼Œå®ç°æš´éœ²é¢æ”¶æ•›
- âœ… éœ€è¦å¼±å¯†ç å®æ—¶æ‹¦æˆªå’Œæš´åŠ›ç ´è§£é˜²æŠ¤
- âœ… éœ€è¦éšè—åç«¯æœåŠ¡æ¥å£ï¼Œé™ä½è¢«æ‰«æé£é™©

**ä¸é€‚åˆçš„åœºæ™¯ï¼š**
- âŒ éœ€è¦ä¿®æ”¹åº”ç”¨ä»£ç çš„åœºæ™¯
- âŒ çº¯é™æ€ç½‘ç«™ï¼ˆæ— éœ€è®¤è¯ï¼‰

**è¯¦ç»†è¯´æ˜è§ï¼š** [readme.md](readme.md#é€‚ç”¨åœºæ™¯)

---

## ğŸ“š æ ¸å¿ƒæ¦‚å¿µï¼ˆ2åˆ†é’Ÿç†è§£ï¼‰

### å››ä¸ªæ ¸å¿ƒæ¨¡å—

| ä»£ç æ’ä»¶ | ä½œç”¨ | ä¸€å¥è¯è¯´æ˜ |
|---------|------|-----------|
| `exposure_auth` | è®¤è¯æ¨¡å— | æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²ç™»å½•ï¼Œæœªç™»å½•åˆ™æ‹¦æˆªæˆ–é‡å®šå‘ |
| `exposure_login` | ç™»å½•æ¨¡å— | Hook ç™»å½•æ¥å£ï¼Œåˆ¤å®šç™»å½•æˆåŠŸ/å¤±è´¥ï¼Œæ”¯æŒå¯†ç ç­–ç•¥ |
| `exposure_user` | ç”¨æˆ·ä¿¡æ¯æ¨¡å— | é€šè¿‡å­è¯·æ±‚è·å–ç”¨æˆ·èº«ä»½ä¿¡æ¯ï¼ˆuser_idã€user_nameï¼‰ |
| `exposure_session` | ä¼šè¯å¤„ç†æ¨¡å— | å®šä¹‰å¦‚ä½•å¤„ç†ä¼šè¯ï¼ˆWISID cookieï¼‰ |

### å·¥ä½œæµç¨‹

**éç™»å½•å£**
```
è¯·æ±‚ â†’ exposure_auth
         â”‚
         â”œâ”€â”€ æœ‰æ•ˆ WISIDï¼ˆè°ƒç”¨exposure_sessionæ£€æµ‹ï¼‰  â†’ æ”¾è¡Œ
         â”‚
         â””â”€â”€ æ— æœ‰æ•ˆ WISID â†’ exposure_user (è·å–ç”¨æˆ·ä¿¡æ¯)
                              â”‚
                              â”œâ”€â”€ æ˜¯å¦æœ‰key_nameå¯¹åº”çš„key value(cookie/header)ï¼Œæ²¡æœ‰çš„è¯ï¼Œæ ¹æ®é…ç½®æ”¾è¡Œ/æ‹’ç»
                                   â”‚
                              â””â”€â”€ æœ‰ï¼Œå¹¶key valueï¼ˆå¯é…ç½®æˆIP+cookieï¼‰æ²¡æœ‰è¯·æ±‚è¿‡ â†’ å‘é€è¯·æ±‚æˆåŠŸ â†’ è®¾ç½® WISID (æ ¹æ®exposure_session) â†’ æ”¾è¡Œ
                                   â””â”€â”€ æœ‰ï¼Œå·²ç»è¯·æ±‚è¿‡ï¼ˆç¼“å­˜é…ç½®ç»†åŒ–ï¼‰ï¼Œä½¿ç”¨ä¸Šæ¬¡çš„ç»“æœ
```

**ç™»å½•å£**
```
exposure_login
       æŒ‰ç…§å®šä¹‰çš„login uriï¼ˆç”±å­è·¯ç”±å®šä¹‰ï¼‰ è¡¨è¾¾å¼åˆ¤æ–­æ˜¯å¦ç™»å½•æˆåŠŸåï¼š
       - å¦‚æœé…ç½®äº† "save_session": trueï¼Œä¼šè°ƒç”¨ exposure_session æ ¹æ® key_name ä¿å­˜ä¼šè¯/cookie
       - å¦‚æœé…ç½®äº† "save_session": falseï¼Œä¸ä¼šä¿å­˜ä¼šè¯ï¼ˆé€‚ç”¨äºç™»å½•æˆåŠŸä½†ä¼šè¯åœ¨åç»­è¯·æ±‚æ‰ç”Ÿæ•ˆçš„åœºæ™¯ï¼Œå¦‚æ³›å¾®V10ï¼‰
```

### é…ç½®ä¼˜å…ˆçº§

```
ä»£ç æ’ä»¶å†…è”é…ç½® > åº”ç”¨ä½œç”¨åŸŸé…ç½® > å…¨å±€é»˜è®¤é…ç½®
```

**è¯¦ç»†è¯´æ˜è§ï¼š** [readme.md](readme.md#æ’ä»¶é…ç½®ä¼˜å…ˆçº§)

---

## ğŸš€ æœ€å°åŒ–é…ç½®ç¤ºä¾‹ï¼ˆ1åˆ†é’Ÿä¸Šæ‰‹ï¼‰

### åœºæ™¯ï¼šæœ€ç®€å•çš„è®¤è¯é…ç½®

å‡è®¾ä½ çš„åº”ç”¨ï¼š
- ç™»å½•æ¥å£ï¼š`POST /api/login`
- ç”¨æˆ·ä¿¡æ¯æ¥å£ï¼š`GET /api/userinfo`ï¼ˆè¿”å› `{"data": {"id": "123", "name": "å¼ ä¸‰"}}`ï¼‰
- éœ€è¦è®¤è¯çš„æ¥å£ï¼šé™¤ç™»å½•æ¥å£å¤–çš„æ‰€æœ‰æ¥å£

**æœ€å°åŒ–é…ç½®ï¼š**

```json
{
  "gw_configures": {
      "plugins": [
        "redirect",
        {
          "name": "exposure_auth",
          "conf": {
          "reject_unauthed": true,
            "response_code": 403,
            "response_msg": "è¯·å…ˆç™»å½•"
          }
        },
        {
            "name": "exposure_session",
            "conf": {
                "key_name": "cookie_WISID"
            }
        }
      ],
      "plugin_confs": {
        "exposure_user": {
        "key_name": "cookie_gitlab_session",
          "sub_requests": [
            {
              "name": "get_user",
              "desc": "è·å–ç”¨æˆ·",
              "uri": "/api/userinfo",
              "method": "GET",
              "fetch_vars": {
                "user_id": {
                  "source": "response_body",
                  "field": "data.id",
                  "parser": "json"
                },
                "user_name": {
                  "source": "response_body",
                  "field": "data.name",
                  "parser": "json"
                }
              },
              "success_expr": ["${upstream_status}", "==", 200]
            }
          ],
          "user_id_var": "${get_user.user_id}",
          "user_name_var": "${get_user.user_name}"
        }
      },
      "sub_routes": [
        {
          "name": "ç™»å½•æ¥å£",
          "plugins": [],
          "routes": [
            {
              "uri": "/api/login",
              "methods": ["POST"]
            }
          ]
        }
      ]
}
}
```

**é…ç½®è¯´æ˜ï¼š**
1. `exposure_auth`ï¼šæ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²ç™»å½•ï¼Œæœªç™»å½•è¿”å› 403
2. `exposure_session`ï¼šå®šä¹‰ä¼šè¯ç®¡ç†æ–¹å¼ï¼Œä½¿ç”¨ WISID cookie ä½œä¸ºè®¤è¯å‡­æ®
3. `exposure_user`ï¼šé€šè¿‡ `/api/userinfo` è·å–ç”¨æˆ·ä¿¡æ¯ï¼Œä½¿ç”¨åº”ç”¨çš„ `gitlab_session` cookie ä½œä¸º key_name
4. `sub_routes`ï¼šç™»å½•æ¥å£æ— éœ€è®¤è¯ï¼ˆç™½åå•ï¼‰

**æ³¨æ„**ï¼šæœ€å°åŒ–é…ç½®ç¤ºä¾‹ä¸­æ²¡æœ‰åŒ…å« `exposure_login`ï¼Œå¦‚æœéœ€è¦ Hook ç™»å½•æ¥å£ï¼ˆå¦‚å¼±å¯†ç æ‹¦æˆªï¼‰ï¼Œéœ€è¦æ·»åŠ ç™»å½•æ¥å£çš„å­è·¯ç”±å’Œ `exposure_login` é…ç½®ã€‚

---

## ğŸ“‹ åˆ†æ­¥é…ç½®æŒ‡å—

### æ­¥éª¤ 1ï¼šåˆ†æåº”ç”¨è®¤è¯æœºåˆ¶

åœ¨å¼€å§‹é…ç½®å‰ï¼Œéœ€è¦å…ˆåˆ†æåº”ç”¨çš„è®¤è¯æœºåˆ¶ï¼š

- **ç™»å½•æ¥å£**ï¼šç¡®å®šåº”ç”¨çš„ç™»å½•æ¥å£ï¼ˆURIã€æ–¹æ³•ã€å‚æ•°æ ¼å¼ï¼‰
- **è®¤è¯å‡­æ®**ï¼šç¡®å®šåº”ç”¨ä½¿ç”¨çš„è®¤è¯å‡­æ®ï¼ˆcookie/header åç§°ï¼‰
- **ç™»å½•æˆåŠŸæ ‡è¯†**ï¼šç¡®å®šç™»å½•æˆåŠŸçš„åˆ¤å®šæ¡ä»¶ï¼ˆå“åº”ç ã€å“åº”ä½“å­—æ®µç­‰ï¼‰

### æ­¥éª¤ 2ï¼šåˆ†æç”¨æˆ·ä¿¡æ¯è·å–æ¥å£

æ‰¾åˆ°ä¸€ä¸ªå¯ä»¥**éªŒè¯ç”¨æˆ·å·²ç™»å½•**å¹¶**è·å–ç”¨æˆ·ä¿¡æ¯**çš„æ¥å£ï¼Œç”¨äºé…ç½® `exposure_user` æ’ä»¶ï¼š

- **æ¥å£ç‰¹å¾**ï¼š
  - æºå¸¦è®¤è¯å‡­æ®ï¼ˆcookie/tokenï¼‰æ—¶è¿”å›ç”¨æˆ·ä¿¡æ¯
  - æœªç™»å½•æˆ–å‡­æ®å¤±æ•ˆæ—¶è¿”å›é”™è¯¯
- **å¸¸è§æ¥å£**ï¼š
  - `/api/userinfo` - ç”¨æˆ·ä¿¡æ¯æ¥å£
  - `/api/me` - å½“å‰ç”¨æˆ·æ¥å£
  - `/api/profile` - ç”¨æˆ·èµ„æ–™æ¥å£
  - `/api/session/check` - ä¼šè¯æ ¡éªŒæ¥å£
- **éœ€è¦æå–çš„ä¿¡æ¯**ï¼š
  - `user_id` - ç”¨æˆ·å”¯ä¸€æ ‡è¯†
  - `user_name` - ç”¨æˆ·åï¼ˆå¯é€‰ï¼‰

### æ­¥éª¤ 3ï¼šåˆ†æç™½åå•æ¥å£

æ¢³ç†**æ— éœ€è®¤è¯**å³å¯è®¿é—®çš„æ¥å£ï¼Œä¸»è¦åŒ…æ‹¬ï¼š

- **ç™»å½•å‰æ¥å£**ï¼šç™»å½•é¡µé¢ã€ç™»å½•æ¥å£ã€éªŒè¯ç æ¥å£ã€æ³¨å†Œæ¥å£ç­‰
- **å…¬å…±æ¥å£**ï¼šå¥åº·æ£€æŸ¥ï¼ˆ`/health`ï¼‰ã€ç›‘æ§æ¥å£ï¼ˆ`/metrics`ï¼‰ã€é™æ€èµ„æºç­‰

### æ­¥éª¤ 4ï¼šé…ç½® exposure_session

åœ¨ `plugin_confs` ä¸­é…ç½®ä¼šè¯ç®¡ç†ï¼š

```json
{
  "plugin_confs": {
    "exposure_session": {
      "key_name": "cookie_WISID"
    }
  }
}
```

- `key_name`ï¼šè®¤è¯ key åç§°ï¼Œå¯ä»¥æ˜¯ cookie æˆ– headerï¼ˆå¦‚ `cookie_WISID`ã€`header_X-Auth-Token`ï¼‰

*æ³¨æ„* key_name æœ€å¥½ä½¿ç”¨åº”ç”¨çš„Cookieï¼Œä½¿ç”¨åº”ç”¨çš„cookieå¥½å¤„åœ¨äºåº”ç”¨é€€å‡ºçš„WEBéšèº«ç›¾ä¹Ÿé€€å‡ºäº†ã€‚


### æ­¥éª¤ 5ï¼šé…ç½® exposure_user

æ‰¾åˆ°åº”ç”¨çš„ç”¨æˆ·ä¿¡æ¯æ¥å£ï¼ˆå¦‚ `/api/user`ã€`/api/userinfo`ï¼‰ï¼Œé…ç½®å­è¯·æ±‚ï¼š

```json
{
  "plugin_confs": {
    "exposure_user": {
      "key_name": "cookie_åº”ç”¨sessionåç§°",
      "sub_requests": [
        {
          "name": "get_user",
          "uri": "/api/user",
          "method": "GET",
          "fetch_vars": {
            "user_id": {
              "source": "response_body",
              "field": "data.id",  // æ ¹æ®å®é™…å“åº”ç»“æ„è°ƒæ•´
              "parser": "json"
            },
            "user_name": {
              "source": "response_body",
              "field": "data.name",  // æ ¹æ®å®é™…å“åº”ç»“æ„è°ƒæ•´
              "parser": "json"
            }
          },
          "success_expr": [
            ["${upstream_status}", "==", 200]
          ]
        }
      ],
      "user_id_var": "${get_user.user_id}",
      "user_name_var": "${get_user.user_name}"
    }
  }
}
```

**å¦‚ä½•ç¡®å®šå­—æ®µè·¯å¾„**ï¼š
- æŸ¥çœ‹æ¥å£å“åº”ç¤ºä¾‹ï¼Œç¡®å®š `user_id` å’Œ `user_name` çš„ JSON è·¯å¾„
- ä¾‹å¦‚å“åº”ä¸º `{"data": {"id": "123", "name": "admin"}}`ï¼Œåˆ™è·¯å¾„ä¸º `data.id` å’Œ `data.name`
- è¯¦ç»†è·¯å¾„è¯­æ³•è§ [path-syntax.md](path-syntax.md)

**æ³¨æ„**ï¼šå¦‚æœæ˜ç¡®è·å–ä¸åˆ° `user_id` å’Œ `user_name`ï¼Œå¯ä»¥è®¾ç½®å›ºå®šå€¼ï¼š
```json
{
  "user_id_var": "unknown",
  "user_name_var": "anonymous"
}
```

### æ­¥éª¤ 6ï¼šé…ç½® exposure_auth

åœ¨ä¸»æ’ä»¶ç»„ä¸­æ·»åŠ è®¤è¯æ’ä»¶ï¼š

```json
{
  "plugins": [
    "redirect",
    "client_ip",
    "uri_bypass",  // å¿…é¡»åœ¨ exposure_auth ä¹‹å‰
    {
      "name": "exposure_auth",
      "conf": {
        "reject_unauthed": true,
        "response_code": 403,
        "response_msg": "ç¦æ­¢è®¿é—®"
      }
    },
    "app_logger"
  ]
}
```

### æ­¥éª¤ 7ï¼šé…ç½®ç™»å½•æ¥å£å­è·¯ç”±

ä¸ºç™»å½•æ¥å£é…ç½®ä¸“é—¨çš„æ’ä»¶ç»„ï¼š

```json
{
  "sub_routes": [
    {
      "name": "ç™»å½•æ¥å£",
      "plugins": [
        "redirect",
        "client_ip",
        {
          "name": "exposure_login",
          "conf": {
            "fetch_vars": {
              "user_id": {
                "source": "request_body",
                "field": "username",  // æ ¹æ®å®é™…è¯·æ±‚å‚æ•°è°ƒæ•´
                "parser": "json"
              },
              "status_code": {
                "source": "response_body",
                "field": "code",  // æ ¹æ®å®é™…å“åº”ç»“æ„è°ƒæ•´
                "parser": "json"
              }
            },
            "user_id_var": "${user_id}",
            "success_expr": [
              ["${upstream_status}", "==", 200]
            ],
            "save_session": true
          }
        }
      ],
      "routes": [
        {
          "uri": "/api/login",  // æ ¹æ®å®é™…ç™»å½•æ¥å£è°ƒæ•´
          "methods": ["POST"]
        }
      ]
    }
  ]
}
```

**å¦‚ä½•ç¡®å®šç™»å½•æˆåŠŸæ¡ä»¶**ï¼š
- æŸ¥çœ‹ç™»å½•æ¥å£çš„å“åº”ï¼Œç¡®å®šæˆåŠŸæ ‡è¯†
- å¸¸è§æƒ…å†µï¼š
  - å“åº”ç ä¸º 200
  - å“åº”ä½“åŒ…å«ç‰¹å®šå­—æ®µï¼ˆå¦‚ `"success": true`ï¼‰
  - å“åº”ä½“åŒ…å«ç”¨æˆ·ä¿¡æ¯
- ä½¿ç”¨ `success_expr` é…ç½®åˆ¤å®šæ¡ä»¶ï¼Œè¯¦ç»†è¯­æ³•è§ [æ¡ä»¶è¡¨è¾¾å¼.md](æ¡ä»¶è¡¨è¾¾å¼.md)

### æ­¥éª¤ 8ï¼šé…ç½®ç™½åå•

æ ¹æ®åº”ç”¨æƒ…å†µé…ç½®ç™½åå•ï¼š

**æ–¹å¼ä¸€ï¼šå­è·¯ç”±ç™½åå•ï¼ˆæ¨èï¼‰**

```json
{
  "sub_routes": [
    {
      "name": "ç™½åå•æ¥å£",
      "plugins": [],
      "routes": [
        {
          "uri": "/health",
          "methods": ["GET"]
        },
        {
          "uri": "/static/*"
        }
      ]
    }
  ]
}
```

**æ–¹å¼äºŒï¼šæ­£åˆ™ç™½åå•ï¼ˆuri_bypassï¼‰**

```json
{
  "plugin_confs": {
    "uri_bypass": {
      "filters": [
        "^/health$",
        "^/static/.*",
        "\\.(css|js|png|jpg)$"
      ]
    }
  }
}
```

è¯¦ç»†é…ç½®è§ [ç™½åå•.md](ç™½åå•.md)ã€‚

---

## ğŸ“‹ å¸¸è§åœºæ™¯æ¨¡æ¿

### æ¨¡æ¿1ï¼šæ ‡å‡† JSON å“åº”åº”ç”¨ï¼ˆå¸¦ç™»å½• Hookï¼‰

**é€‚ç”¨åœºæ™¯ï¼š** åº”ç”¨ç™»å½•æ¥å£è¿”å› JSONï¼Œæ ¼å¼ä¸º `{"code": 200, "data": {"user_id": "123"}}`ï¼Œéœ€è¦ Hook ç™»å½•æ¥å£è¿›è¡Œå¼±å¯†ç æ‹¦æˆªç­‰å®‰å…¨é˜²æŠ¤

```json
{
  "gw_configures": {
  "plugins": [
    "redirect",
    {
      "name": "exposure_auth",
      "conf": {
          "reject_unauthed": true,
        "response_code": 403
      }
    },
    {
      "name": "exposure_session",
      "conf": {
        "key_name": "cookie_WISID"
      }
    }
  ],
  "plugin_confs": {
    "exposure_user": {
        "key_name": "cookie_gitlab_session",
      "sub_requests": [
        {
          "name": "get_user",
          "desc": "è·å–ç”¨æˆ·",
          "uri": "/api/userinfo",
          "headers": {"Cookie": "$http_cookie"},
          "fetch_vars": {
            "user_id": {"source": "response_body", "field": "data.user_id", "parser": "json"},
            "user_name": {"source": "response_body", "field": "data.user_name", "parser": "json"}
          },
          "success_expr": ["${upstream_status}", "==", 200]
        }
      ],
      "user_id_var": "${get_user.user_id}",
      "user_name_var": "${get_user.user_name}"
    }
  },
  "sub_routes": [
    {
      "name": "login",
      "desc": "ç™»å½•æ¥å£",
      "plugin_group_id": "login_group",
      "routes": [{"uri": "/api/login", "methods": ["POST"]}]
    }
    ],
   "plugin_groups": {
    "login_group": [
      "passwd_restriction",
      {
        "name": "exposure_login",
        "conf": {
          "fetch_vars": {
            "user_id": {
              "source": "response_body",
              "field": "data.user.id",
              "parser": "json"
            },
            "code": {
              "source": "response_body",
              "field": "code",
              "parser": "json"
            }
          },
          "user_id_var": "${user_id}",
          "success_expr": [
            ["${upstream_status}", "==", 200],
            ["${code}", "==", 200]
          ],
          "save_session": true
        }
      }
    ]
    }
  }
}
```

### æ¨¡æ¿2ï¼šä½¿ç”¨åº”ç”¨è‡ªèº« Cookie è®¤è¯

**é€‚ç”¨åœºæ™¯ï¼š** åº”ç”¨å·²æœ‰è‡ªå·±çš„ session cookieï¼ˆå¦‚ `JSESSIONID`ï¼‰ï¼Œä¸æƒ³ä½¿ç”¨ WISID

```json
{
  "gw_configures": {
  "plugins": [
    "redirect",
    {
      "name": "exposure_auth",
      "conf": {
          "log_unauthed": true
      }
    },
      {
                "name": "exposure_session",
                "conf": {
          "key_name": "cookie_JSESSIONID"
        }
                }
  ],
  "plugin_confs": {
    "exposure_user": {
        "key_name": "cookie_gitlab_session",
      "sub_requests": [
        {
          "name": "get_user",
          "desc": "è·å–ç”¨æˆ·",
          "uri": "/api/userinfo",
          "fetch_vars": {
            "user_id": {"source": "response_body", "field": "data.id", "parser": "json"}
          },
          "success_expr": ["${upstream_status}", "==", 200]
        }
      ],
      "user_id_var": "${get_user.user_id}"
    }
    }
  }
}
```

**æ³¨æ„ï¼š**
- ä½¿ç”¨åº”ç”¨è‡ªèº« cookie æ—¶ï¼Œ`exposure_session` ä¸ä¼š set-cookieï¼Œåªç”¨äºè®¤è¯åˆ¤æ–­
- åº”ç”¨éœ€è¦è‡ªå·±ç®¡ç† cookie çš„è¿‡æœŸæ—¶é—´

### æ¨¡æ¿3ï¼šå¸¦é™æ€èµ„æºç™½åå•

**é€‚ç”¨åœºæ™¯ï¼š** éœ€è¦ç™½åå•é™æ€èµ„æºï¼ˆCSSã€JSã€å›¾ç‰‡ç­‰ï¼‰

```json
{
  "gw_configures": {
  "plugins": [
    "redirect",
      "uri_bypass",
    {
      "name": "exposure_auth",
      "conf": {
          "reject_unauthed": true,
        "response_code": 403
      }
      },
      {
                "name": "exposure_session",
                "conf": {
                "key_name": "cookie_WISID"
        }
                }
  ],
  "plugin_confs": {
      "uri_bypass": {
      "filters": [
            "^/static/.*",
            "^/assets/.*",
            "\\.(css|js|png|jpg|gif|ico|svg|woff|woff2)$"
      ]
    },
    "exposure_user": {
        "key_name": "cookie_gitlab_session",
      "sub_requests": [
        {
          "name": "get_user",
          "desc": "è·å–ç”¨æˆ·",
          "uri": "/api/userinfo",
          "fetch_vars": {
            "user_id": {"source": "response_body", "field": "data.id", "parser": "json"}
          },
          "success_expr": ["${upstream_status}", "==", 200]
        }
      ],
      "user_id_var": "${get_user.user_id}"
      }
    }
  }
}
```

**æ³¨æ„ï¼š** `uri_bypass` å¿…é¡»é…ç½®åœ¨ `exposure_auth` **ä¹‹å‰**ã€‚

---

## âœ… æµ‹è¯•éªŒè¯

### 1. æµ‹è¯•ç™»å½•æ¥å£

   ```bash
# æµ‹è¯•ç™»å½•æ¥å£
curl -X POST http://your-app/login \
  -H "Content-Type: application/json" \
  -d '{"user": "admin", "password": "password123"}'
```

**é¢„æœŸç»“æœ**ï¼š
- ç™»å½•æˆåŠŸï¼šè¿”å› 200ï¼Œè®¾ç½® `WISID` cookie
- ç™»å½•å¤±è´¥ï¼šè¿”å› 401 æˆ–å…¶ä»–é”™è¯¯ç 

### 2. æµ‹è¯•è®¤è¯

   ```bash
# æœªç™»å½•è®¿é—®å—ä¿æŠ¤æ¥å£
curl http://your-app/api/protected

# é¢„æœŸï¼šè¿”å› 403 æˆ–é‡å®šå‘åˆ°ç™»å½•é¡µ

# æºå¸¦ WISID cookie è®¿é—®
curl http://your-app/api/protected \
  -H "Cookie: WISID=your-wisid-value"

# é¢„æœŸï¼šæ­£å¸¸è¿”å›æ•°æ®
```

### 3. æµ‹è¯•ç™½åå•

   ```bash
# è®¿é—®ç™½åå•æ¥å£ï¼ˆæ— éœ€è®¤è¯ï¼‰
curl http://your-app/health
curl http://your-app/static/style.css

# é¢„æœŸï¼šæ­£å¸¸è¿”å›ï¼Œä¸è¦æ±‚è®¤è¯
```

### 4. æµ‹è¯•ç”¨æˆ·ä¿¡æ¯è·å–

å½“æœ¬åœ° session ä¸å­˜åœ¨æ—¶ï¼Œ`exposure_user` ä¼šå‘èµ·å­è¯·æ±‚è·å–ç”¨æˆ·ä¿¡æ¯ã€‚å¯ä»¥é€šè¿‡æ—¥å¿—æŸ¥çœ‹å­è¯·æ±‚çš„æ‰§è¡Œæƒ…å†µã€‚

---

## ğŸ”§ AIè‡ªåŠ¨ç”Ÿæˆæ’ä»¶æ–¹æ³•

**æ¨èå‚è€ƒï¼š** ã€ŠCursor+HAR ç¼–å†™é›¶æ”¹é€ æ’ä»¶è§„åˆ™å®è·µæ‰‹å†Œã€‹


---

## ğŸ’¡ å¿«é€Ÿå‚è€ƒ

### å¸¸ç”¨å˜é‡

| å˜é‡ | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|
| `cookie_WISID` | WISID cookie | `"key_name": "cookie_WISID"` |
| `$http_cookie` | å®Œæ•´ Cookie å­—ç¬¦ä¸² | `"Cookie": "$http_cookie"` |
| `$remote_addr` | å®¢æˆ·ç«¯ IP | `"X-Real-IP": "$remote_addr"` |
| `$post_arg_username` | POST å‚æ•° | `"username": "$post_arg_username"` |
| `$arg_type` | æŸ¥è¯¢å‚æ•° | `["$arg_type", "==", "mobile"]` |

### å¸¸ç”¨è¡¨è¾¾å¼

| è¡¨è¾¾å¼ | è¯´æ˜ |
|--------|------|
| `["${upstream_status}", "==", 200]` | å“åº”çŠ¶æ€ç ä¸º 200 |
| `["${user_id}", "~=", ""]` | user_id ä¸ä¸ºç©º |
| `["AND", ["${upstream_status}", "==", 200], ["${user_id}", "~=", ""]]` | åŒæ—¶æ»¡è¶³ä¸¤ä¸ªæ¡ä»¶ |

### å¸¸ç”¨è·¯å¾„æå–

| è·¯å¾„ | è¯´æ˜ |
|------|------|
| `data.user.id` | JSON ç®€å•è·¯å¾„ |
| `$.data.users[*].id` | JSONPath æ•°ç»„æå– |
| `user_id[=:]([0-9]+)` | æ­£åˆ™è¡¨è¾¾å¼æå– |

---

## ğŸ“– ä¸‹ä¸€æ­¥å­¦ä¹ è·¯å¾„

### åŸºç¡€é…ç½®ï¼ˆå·²å®Œæˆ âœ…ï¼‰
- [x] æœ€å°åŒ–é…ç½®
- [x] åˆ†æ­¥é…ç½®æŒ‡å—
- [x] å¸¸è§åœºæ™¯æ¨¡æ¿

### è¿›é˜¶é…ç½®
1. **ç™»å½•æ¥å£ Hook**
   - é˜…è¯»ï¼š[exposure_login.md](exposure_login.md)
   - å­¦ä¹ ï¼šå¦‚ä½•åˆ¤å®šç™»å½•æˆåŠŸ/å¤±è´¥ï¼Œå¦‚ä½•æå–ç”¨æˆ·ä¿¡æ¯

2. **å¤æ‚å˜é‡æå–**
   - é˜…è¯»ï¼š[path-syntax.md](path-syntax.md)
   - å­¦ä¹ ï¼šJSONPathã€æ­£åˆ™è¡¨è¾¾å¼æå–

3. **è¡¨è¾¾å¼åˆ¤å®š**
   - é˜…è¯»ï¼š[æ¡ä»¶è¡¨è¾¾å¼.md](æ¡ä»¶è¡¨è¾¾å¼.md)
   - å­¦ä¹ ï¼šå¤æ‚æ¡ä»¶ç»„åˆï¼ŒAND/OR åµŒå¥—

4. **å­è·¯ç”±é«˜çº§ç”¨æ³•**
   - é˜…è¯»ï¼š[å­è·¯ç”±.md](å­è·¯ç”±.md)
   - å­¦ä¹ ï¼šæ¡ä»¶åŒ¹é…ã€å‚æ•°åŒ¹é…ã€å¤šè·¯ç”±ç»„åˆ

### é«˜çº§é…ç½®
5. **å¤šå­è¯·æ±‚é…ç½®**
   - é˜…è¯»ï¼š[exposure_user.md](exposure_user.md)
   - å­¦ä¹ ï¼šæ¡ä»¶æ‰§è¡Œã€å˜é‡ä¼ é€’

6. **å˜é‡ç³»ç»Ÿ**
   - é˜…è¯»ï¼š[å˜é‡.md](å˜é‡.md)
   - å­¦ä¹ ï¼šæ‰€æœ‰å¯ç”¨å˜é‡ã€åŠ¨æ€å‚æ•°è¯­æ³•

7. **å®Œæ•´é…ç½®å‚è€ƒ**
   - é˜…è¯»ï¼š[readme.md](readme.md)
   - æŸ¥çœ‹ï¼šå®Œæ•´é…ç½®ç¤ºä¾‹å’Œæœ€ä½³å®è·µ

---

## å¸¸è§é—®é¢˜

### 1. è®¤è¯å¤±è´¥ï¼Œè¿”å› 403

**å¯èƒ½åŸå› **ï¼š
- `exposure_session` æœªé…ç½®æˆ–é…ç½®é”™è¯¯
- `exposure_user` å­è¯·æ±‚å¤±è´¥
- `key_name` é…ç½®é”™è¯¯

**æ’æŸ¥æ­¥éª¤**ï¼š
1. æ£€æŸ¥ `plugin_confs.exposure_session` é…ç½®
2. æ£€æŸ¥ `plugin_confs.exposure_user` é…ç½®
3. æŸ¥çœ‹æ—¥å¿—ï¼Œç¡®è®¤å­è¯·æ±‚æ˜¯å¦æˆåŠŸ

### 2. ç™»å½•æ¥å£æ— æ³•ä¿å­˜ä¼šè¯

**å¯èƒ½åŸå› **ï¼š
- `exposure_login` çš„ `success_expr` é…ç½®é”™è¯¯
- `save_session` æœªè®¾ç½®ä¸º `true`
- `exposure_session` æœªé…ç½®

**æ’æŸ¥æ­¥éª¤**ï¼š
1. æ£€æŸ¥ `success_expr` æ˜¯å¦åŒ¹é…ç™»å½•æˆåŠŸçš„æ¡ä»¶
2. ç¡®è®¤ `save_session: true`
3. æ£€æŸ¥ `exposure_session` é…ç½®

### 3. ç™½åå•ä¸ç”Ÿæ•ˆ

**å¯èƒ½åŸå› **ï¼š
- `uri_bypass` é…ç½®åœ¨ `exposure_auth` ä¹‹å
- æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…é”™è¯¯

**æ’æŸ¥æ­¥éª¤**ï¼š
1. ç¡®è®¤ `uri_bypass` åœ¨æ’ä»¶ç»„ä¸­çš„ä½ç½®ï¼ˆå¿…é¡»åœ¨ `exposure_auth` ä¹‹å‰ï¼‰
2. æµ‹è¯•æ­£åˆ™è¡¨è¾¾å¼æ˜¯å¦æ­£ç¡®åŒ¹é… URI

### 4. æ— æ³•æå–ç”¨æˆ·ä¿¡æ¯

**å¯èƒ½åŸå› **ï¼š
- `fetch_vars` å­—æ®µè·¯å¾„é…ç½®é”™è¯¯
- å“åº”æ ¼å¼ä¸é…ç½®ä¸åŒ¹é…

**æ’æŸ¥æ­¥éª¤**ï¼š
1. æŸ¥çœ‹å®é™…å“åº”å†…å®¹
2. æ£€æŸ¥ JSON è·¯å¾„æ˜¯å¦æ­£ç¡®ï¼ˆä½¿ç”¨ [path-syntax.md](path-syntax.md) éªŒè¯ï¼‰
3. æŸ¥çœ‹æ—¥å¿—ä¸­çš„å˜é‡æå–ç»“æœ

**æ›´å¤šé—®é¢˜è§ï¼š** [FAQ.md](FAQ.md)

---

## å‚è€ƒæ–‡æ¡£

- [readme.md](readme.md) - æ•´ä½“æ¶æ„å’Œé…ç½®è¯´æ˜
- [exposure_auth.md](exposure_auth.md) - è®¤è¯æ’ä»¶è¯¦ç»†é…ç½®
- [exposure_login.md](exposure_login.md) - ç™»å½•æ’ä»¶è¯¦ç»†é…ç½®
- [exposure_user.md](exposure_user.md) - ç”¨æˆ·ä¿¡æ¯è·å–æ’ä»¶è¯¦ç»†é…ç½®
- [exposure_session.md](exposure_session.md) - ä¼šè¯ç®¡ç†æ’ä»¶è¯¦ç»†é…ç½®
- [ç™½åå•.md](ç™½åå•.md) - ç™½åå•é…ç½®è¯´æ˜
- [å­è·¯ç”±.md](å­è·¯ç”±.md) - å­è·¯ç”±é…ç½®è¯´æ˜
- [å˜é‡.md](å˜é‡.md) - å˜é‡å¼•ç”¨å’Œ fetch_vars é…ç½®
- [æ¡ä»¶è¡¨è¾¾å¼.md](æ¡ä»¶è¡¨è¾¾å¼.md) - è¡¨è¾¾å¼è¯­æ³•è¯´æ˜
- [path-syntax.md](path-syntax.md) - JSON/XML è·¯å¾„æå–è¯­æ³•
- [FAQ.md](FAQ.md) - å¸¸è§é—®é¢˜è§£ç­”

---

**ğŸ‰ æ­å–œï¼ä½ å·²ç»æŒæ¡äº†é›¶æ”¹é€ å¼•æ“è§„åˆ™çš„åŸºç¡€é…ç½®ã€‚ç°åœ¨å¯ä»¥å¼€å§‹é…ç½®ä½ çš„åº”ç”¨äº†ï¼**
