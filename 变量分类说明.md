# 变量分类说明文档

## 概述

本文档说明平台支持的变量类型及其引用方式。变量分为两类：

- **系统变量**：nginx/apisix 内置变量，使用 `$变量名` 格式引用
- **自定义变量**：插件变量，用户通过 `fetch_vars` 提取的变量，使用 `${变量名}` 格式引用

## 变量引用格式

| 变量类型 | 引用格式 | 使用场景 | 示例 |
|---------|---------|---------|------|
| 系统变量 | `$变量名` | 子路由匹配（`vars`）、子请求条件执行（`exec_expr`）、动态参数替换 | `$remote_addr`、`$arg_id`、`$http_user_agent` |
| 自定义变量 | `${变量名}` | 登录成功判定（`success_expr`）、账密失败判定（`passwd_failed_expr`）、插件变量引用 | `${upstream_status}`、`${user_id}`、`${header_content_type}` |

**注意**：虽然代码执行时会去除 `$` 和 `${}` 前缀，但使用不同的引用格式有助于区分变量来源，提高配置的可读性和可维护性。

## 系统变量

系统变量来自 `api_ctx.var`，包含 nginx 内置变量和平台扩展变量。系统变量使用 `$变量名` 格式引用。

### Cookie 变量

通过 `cookie_` 前缀获取请求中的 Cookie 值。

| 变量格式 | 说明 | 示例 |
|---------|------|------|
| `$cookie_xxx` | 获取名为 xxx 的 Cookie 值 | `$cookie_WISID`、`$cookie_session_id` |

**示例**：

```json
{
  "fetch_vars": {
    "session": "$cookie_session_id",
    "tsid": "$cookie_WISID"
  }
}
```

```json
{
  "vars": [
    ["$cookie_WISID", "~=", ""]
  ]
}
```

### 查询参数变量

通过 `arg_` 前缀获取 URL 查询参数（Query String）的值。

| 变量格式 | 说明 | 示例 |
|---------|------|------|
| `$arg_xxx` | 获取查询参数 xxx 的值 | `$arg_id`、`$arg_type`、`$arg_page` |

**注意**：如果参数有多个值，返回第一个值。

**示例**：

请求：`/api/user?id=%25123&type=admin`

```json
{
  "fetch_vars": {
    "user_id": "$arg_id",
    "user_type": "$arg_type"
  }
}
```

```json
{
  "vars": [
    ["$arg_type", "==", "mobile"]
  ]
}
```

**注意： $uri，$request_uri , $arg_xxx , $post_arg_xxx 都是做过一次url decoded的，例如这里$arg_idw为%123**

### POST 表单参数变量

通过 `post_arg_` 前缀获取 POST 表单参数的值。

| 变量格式 | 说明 | 示例 |
|---------|------|------|
| `$post_arg_xxx` | 获取 POST 表单参数 xxx 的值 | `$post_arg_username`、`$post_arg_password` |

**注意**：
- 仅支持 `Content-Type: application/x-www-form-urlencoded` 格式的请求体
- 不支持 `multipart/form-data` 或 `application/json`
- 如果参数有多个值，返回第一个值

**示例**：

```json
{
  "fetch_vars": {
    "username": "$post_arg_username",
    "password": "$post_arg_password"
  }
}
```

### 请求头变量

通过 `http_` 前缀获取请求头的值。

| 变量格式 | 说明 | 示例 |
|---------|------|------|
| `$http_xxx` | 获取请求头 xxx 的值 | `$http_host`、`$http_user_agent` |

**命名规则**：
- 请求头名称转换为小写
- `-` 替换为 `_`
- 例如：`X-Auth-Token` → `$http_x_auth_token`

**常用请求头变量**：

| 变量名 | 对应请求头 |
|--------|-----------|
| `$http_host` | Host |
| `$http_user_agent` | User-Agent |
| `$http_referer` | Referer |
| `$http_authorization` | Authorization |
| `$http_content_type` | Content-Type |
| `$http_content_length` | Content-Length |
| `$http_x_forwarded_for` | X-Forwarded-For |
| `$http_x_real_ip` | X-Real-IP |
| `$http_x_auth_token` | X-Auth-Token |
| `$http_cookie` | Cookie（完整 cookie 字符串） |

**示例**：

```json
{
  "fetch_vars": {
    "auth_token": "$http_authorization",
    "client_type": "$http_x_client_type"
  }
}
```

```json
{
  "vars": [
    ["$http_user_agent", "~~", "Mobile"]
  ]
}
```

### URI 扩展变量

通过 `uri_` 前缀获取 URI 的各个组成部分。

| 变量名 | 说明 | 示例 URI | 返回值 |
|--------|------|---------|--------|
| `$uri_ext` | 文件扩展名 | `/path/file.html` | `html` |
| `$uri_suffix` | 文件扩展名（同 ext） | `/path/file.json` | `json` |
| `$uri_name` | 文件名（含扩展名） | `/path/file.html` | `file.html` |
| `$uri_dir` | 目录路径 | `/path/to/file.html` | `/path/to` |

**示例**：

```json
{
  "vars": [
    ["$uri_ext", "in", ["html", "htm", "php"]]
  ]
}
```

### Nginx 内置变量

以下是常用的 nginx 内置变量，可直接使用变量名引用：

#### 请求信息

| 变量名 | 说明 | 示例值 |
|--------|------|--------|
| `$uri` | 请求 URI（不含查询参数） | `/api/user` |
| `$request_uri` | 完整请求 URI（含查询参数） | `/api/user?id=123` |
| `$args` | 查询参数字符串 | `id=123&type=admin` |
| `$is_args` | 是否有查询参数 | `?` 或空 |
| `$method` | HTTP 请求方法 | `GET`、`POST` |
| `$scheme` | 请求协议 | `http`、`https` |
| `$host` | 请求 Host | `www.example.com` |
| `$request_method` | HTTP 请求方法 | `GET`、`POST` |
| `$request_length` | 请求长度（字节） | `256` |
| `$request_time` | 请求处理时间（秒） | `0.123` |

#### 客户端信息

| 变量名 | 说明 | 示例值 |
|--------|------|--------|
| `$remote_addr` | 客户端 IP | `192.168.1.100` |
| `$remote_port` | 客户端端口 | `54321` |
| `$remote_user` | Basic 认证用户名 | `admin` |
| `$binary_remote_addr` | 客户端 IP（二进制） | - |


## 自定义变量

自定义变量包括：
- 通过 `fetch_vars` 配置提取的变量，作用域为当前插件
- 子请求响应时自动注入的内置变量

自定义变量使用 `${变量名}` 格式引用。

### 内置默认变量

当插件发起子请求或处理响应时（目前`exposure_login`hook的登录请求，以及`exposure_user`发起的子请求），系统会自动注入以下变量：

#### 响应状态码变量

| 变量名 | 说明 | 示例值 |
|--------|------|--------|
| `${upstream_status}` | 上游响应状态码（子请求或代理请求的响应状态码） | `200`、`401`、`500` |

#### 响应头变量

响应头会自动转换为变量，格式为 `header_xxx_xxx`：

| 变量格式 | 说明 | 示例 |
|---------|------|------|
| `${header_xxx_xxx}` | 响应头 xxx-xxx 的值（转换为小写，`-` 替换为 `_`，前缀 `header_`） | `Content-Type: application/json` → `${header_content_type}` |

**命名规则**：
- 响应头名称转换为小写
- `-` 替换为 `_`
- 前缀 `header_`
- 例如：`X-Auth-Token: abc123` → `${header_x_auth_token}`

**常用响应头变量**：

| 变量名 | 对应响应头 |
|--------|-----------|
| `${header_content_type}` | Content-Type |
| `${header_content_length}` | Content-Length |
| `${header_location}` | Location |
| `${header_set_cookie}` | Set-Cookie |
| `${header_x_auth_token}` | X-Auth-Token |

**示例**：

```json
{
  "success_expr": [
    ["${upstream_status}", "==", 200],
    ["${header_content_type}", "~~", "application/json"]
  ]
}
```

### fetch_vars 变量提取

`fetch_vars` 用于从请求或响应中提取变量，支持简单格式和详细格式两种配置方式。

#### 简单格式

简单格式直接引用系统变量，支持变量替换和字符串拼接。

**格式**：
```json
{
  "fetch_vars": {
    "变量名": "$系统变量名",
    "变量名": "字符串 $系统变量名 字符串"
  }
}
```

**示例**：

```json
{
  "fetch_vars": {
    "client_ip": "$remote_addr",
    "username": "$post_arg_username",
    "auth_token": "$http_authorization",
    "session_id": "$cookie_session",
    "request_type": "$arg_type",
    "uuid": "prefix-$remote_addr-$cookie_WISID"
  }
}
```

**说明**：
- 变量名：提取后的变量名，可在后续表达式中使用 `${变量名}` 引用
- 值：可以是单个系统变量引用（如 `$remote_addr`），也可以是包含多个系统变量的字符串（如 `"prefix-$remote_addr-$cookie_WISID"`）
- 支持转义：使用 `\$` 可以转义 `$`，例如 `"abc \$remote_addr"` → `"abc $remote_addr"`

#### 详细格式

详细格式支持从多种数据源提取变量，并支持多种解析器。

**格式**：
```json
{
  "fetch_vars": {
    "变量名": {
      "source": "数据源",
      "field": "XAUTH_",
      "parser": "解析器类型（可选）",
      "regex": "正则表达式（可选）",
      "options": "正则表达式选项（可选）",
      "select": "值选择器（可选）",
      "cast": "类型转换（可选）"
    }
  }
}
```

**字段说明**：

| 字段 | 类型 | 必需 | 说明 |
|------|------|------|------|
| `source` | string | 是 | 数据源，可选值：`var_ref`、`request_body`、`response_header`、`response_body` |
| `field` | string | 是 | 字段名或路径，根据 `source` 和 `parser` 不同而不同 |
| `parser` | string | 否 | 解析器类型，可选值：`json`、`xml`（暂未实现）、`regex`。仅当 `source` 为 `request_body` 或 `response_body` 时使用 |
| `regex` | string | 否 | 正则表达式，用于对提取的值进行二次过滤。当 `source` 为 `var_ref` 或 `response_header` 时使用 |
| `options` | string | 否 | 正则表达式选项，如 `"jo"`（仅当使用 `regex` 时） |
| `select` | object | 否 | 值选择器，用于处理数组或表类型的值。支持 `index`、`first`、`join`、`json` |
| `cast` | string | 否 | 类型转换，可选值：`string`、`number` |

**数据源说明**：

##### 1. var_ref - 引用系统变量

从 `api_ctx.var` 中引用系统变量，支持通过正则进一步提取。

**配置示例**：

```json
{
  "fetch_vars": {
    "user_id": {
      "source": "var_ref",
      "field": "$http_authorization",
      "regex": "Bearer ([^\\s]+)"
    }
  }
}
```

**说明**：
- `field`：系统变量名，必须使用 `$变量名` 格式（如 `$http_authorization`、`$remote_addr`）
- `regex`：可选，对提取的值进行正则匹配，默认返回第一个捕获组

##### 2. request_body - 从请求体提取

从请求体中提取变量，支持 JSON、XML（暂未实现）、正则表达式解析。

**配置示例**：

从 JSON 请求体中提取：
```json
{
  "fetch_vars": {
    "user_id": {
      "source": "request_body",
      "field": "data.user.id",
      "parser": "json"
    }
  }
}
```

从请求体使用正则提取：
```json
{
  "fetch_vars": {
    "user_id": {
      "source": "request_body",
      "field": "user_id[=:]([0-9]+)",
      "parser": "regex",
    }
  }
}
```

**说明**：
- `field`：
  - 当 `parser` 为 `json` 时，使用 JSON 路径（如 `data.user.id` 或 `$.data.user.id`），详细语法见 [path-syntax.md](path-syntax.md)
  - 当 `parser` 为 `regex` 时，使用正则表达式
- `parser`：`json`、`xml`（暂未实现）、`regex`
- `options`：正则表达式选项，如 `"jo"`（仅当使用 `regex` 时）

##### 3. response_header - 从响应头提取

从响应头中提取变量，支持通过正则进一步过滤。

**配置示例**：

```json
{
  "fetch_vars": {
    "user_id": {
      "source": "response_header",
      "field": "X-Auth-Token",
      "regex": "user_id:([^,]+)"
    }
  }
}
```

**说明**：
- `field`：响应头名称（如 `X-Auth-Token`），注意不是变量名格式
- `regex`：可选，对提取的值进行正则匹配，默认返回第一个捕获组
- **注意**：响应头本身已经是内置变量（`${header_xxx_xxx}`），此方式主要用于需要进一步正则提取的场景

##### 4. response_body - 从响应体提取

从响应体中提取变量，支持 JSON、XML（暂未实现）、正则表达式解析。

**配置示例**：

从 JSON 响应体中提取：
```json
{
  "fetch_vars": {
    "user_id": {
      "source": "response_body",
      "field": "data.user.id",
      "parser": "json"
    }
  }
}
```

从响应体使用正则提取：
```json
{
  "fetch_vars": {
    "user_id": {
      "source": "response_body",
      "field": "user_id[=:]([0-9]+)",
      "parser": "regex",
    }
  }
}
```

**说明**：
- `field`：
  - 当 `parser` 为 `json` 时，使用 JSON 路径（如 `data.user.id` 或 `$.data.user.id`），详细语法见 [path-syntax.md](path-syntax.md)
  - 当 `parser` 为 `regex` 时，使用正则表达式
- `parser`：`json`、`xml`（暂未实现）、`regex`
- `options`：正则表达式选项，如 `"jo"`（仅当使用 `regex` 时）

**值选择器（select）**：

当提取的值为数组或表类型时，可以使用 `select` 进行选择：

```json
{
  "fetch_vars": {
    "user_id": {
      "source": "response_body",
      "field": "users[*].id",
      "parser": "json",
      "select": {
        "type": "first"
      }
    }
  }
}
```

**select 类型**：

| 类型 | 说明 | 配置示例 |
|------|------|---------|
| `index` | 按索引选择 | `{"type": "index", "index": 0}` |
| `first` | 选择第一个非空值 | `{"type": "first"}` |
| `join` | 使用分隔符连接 | `{"type": "join", "sep": ","}` |
| `json` | 转换为 JSON 字符串 | `{"type": "json"}` |

**类型转换（cast）**：

对提取的值进行类型转换：

```json
{
  "fetch_vars": {
    "user_id": {
      "source": "response_body",
      "field": "data.user.id",
      "parser": "json",
      "cast": "number"
    }
  }
}
```

**cast 类型**：

| 类型 | 说明 |
|------|------|
| `string` | 转换为字符串 |
| `number` | 转换为数字 |

#### 完整示例

**示例 1：从响应 JSON 中提取用户信息**

```json
{
  "fetch_vars": {
    "user_id": {
      "source": "response_body",
      "field": "data.user.id",
      "parser": "json"
    },
    "user_name": {
      "source": "response_body",
      "field": "data.user.name",
      "parser": "json"
    }
  }
}
```

**示例 2：从响应头中提取并正则过滤**

```json
{
  "fetch_vars": {
    "user_id": {
      "source": "response_header",
      "field": "X-Auth-Token",
      "regex": "user_id:([^,]+)"
    }
  }
}
```

**示例 3：从请求体使用正则提取**

```json
{
  "fetch_vars": {
    "user_id": {
      "source": "request_body",
      "field": "user_id[=:]([0-9]+)",
      "parser": "regex",
    }
  }
}
```

**示例 4：混合使用简单格式和详细格式**

```json
{
  "fetch_vars": {
    "client_ip": "$remote_addr",
    "username": "$post_arg_username",
    "user_id": {
      "source": "response_body",
      "field": "data.user.id",
      "parser": "json"
    },
    "auth_token": {
      "source": "response_header",
      "field": "X-Auth-Token"
    }
  }
}
```

## 使用示例

### 子路由匹配

```json
{
  "routes": [
    {
      "uri": "/api/login",
      "methods": ["POST"],
      "vars": ["AND",
        ["$arg_platform", "==", "mobile"],
        ["$http_user_agent", "~~", "Android"]
      ]
    }
  ]
}
```

### 动态参数替换

```json
{
  "uri": "/api/user/$arg_user_id",
  "headers": {
    "X-Real-IP": "$remote_addr",
    "X-Forwarded-For": "$http_x_forwarded_for",
    "Authorization": "$http_authorization"
  }
}
```

### 表达式判定（使用自定义变量）

```json
{
  "success_expr": [
    ["${upstream_status}", "==", 200],
    ["${user_id}", "~=", ""]
  ]
}
```

## 注意事项

1. **变量引用格式**：
   - 系统变量必须使用 `$变量名` 格式（如 `$remote_addr`、`$arg_id`）
   - 自定义变量必须使用 `${变量名}` 格式（如 `${upstream_status}`、`${user_id}`）

2. **变量缓存**：大部分系统变量会被缓存，`args` 和 `is_args` 例外（因为可能被修改）

3. **POST 参数限制**：`post_arg_xxx` 仅支持 `application/x-www-form-urlencoded` 格式

4. **请求头命名**：`http_xxx` 变量名中，请求头名称需要转换为小写并将 `-` 替换为 `_`

5. **响应头命名**：`header_xxx_xxx` 变量名中，响应头名称需要转换为小写并将 `-` 替换为 `_`，前缀 `header_`

6. **多值参数**：查询参数和 POST 参数如果有多个同名值，只返回第一个

7. **空值处理**：变量不存在或值为空时，返回 `nil`

8. **大小写**：变量名统一使用小写

9. **fetch_vars 变量作用域**：`fetch_vars` 提取的变量存储在插件的私有变量集合中，不同插件的 `fetch_vars` 变量互不影响

10. **子请求响应变量**：当插件发起子请求时，系统会自动注入 `upstream_status` 和 `header_xxx_xxx` 变量，无需在 `fetch_vars` 中配置
