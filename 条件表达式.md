# 条件表达式

`lua-resty-expr` 是一个用于条件判定的表达式库，在暴露面收敛相关插件中广泛用于：

- **子路由匹配**：`vars` - 子路由的额外匹配条件
- **子请求条件执行**：`exec_expr` - 控制子请求是否执行
- **登录成功判定**：`success_expr` - 判定请求/子请求是否成功
- **账密失败判定**：`passwd_failed_expr` - 判定账密登录是否失败

## 变量引用格式

根据使用场景，变量引用格式不同：

### 系统变量（使用 `$` 引用）

以下场景使用系统变量（`api_ctx.var`），必须使用 `$变量名` 格式：

- **子路由匹配**（`vars`）：用于子路由的额外匹配条件
- **子请求条件执行**（`exec_expr`）：控制子请求是否执行

**示例**：
```json
{
  "vars": [
    ["$http_user_agent", "~~", "Mobile"],
    ["$method", "==", "POST"]
  ]
}
```

```json
{
  "exec_expr": [["$http_user_agent", "~~", "Mobile"]]
}
```

### 自定义变量（使用 `${}` 引用）

以下场景使用自定义变量（`fetch_vars` 提取的变量或响应内置变量），必须使用 `${变量名}` 格式：

- **登录成功判定**（`success_expr`）：判定登录请求是否成功
- **账密失败判定**（`passwd_failed_expr`）：判定账密登录是否失败

**示例**：
```json
{
  "success_expr": [
    ["${upstream_status}", "==", 200],
    ["${user_id}", "~=", ""]
  ]
}
```

```json
{
  "passwd_failed_expr": ["OR",
    ["${upstream_status}", "==", 401],
    ["${error_code}", "==", "INVALID_PASSWORD"]
  ]
}
```

**注意**：虽然代码执行最终创建匹配对象时会去除 `$` 和 `${}` 前缀，但使用不同的引用格式有助于区分变量来源：
- `$变量名` → 系统变量（`api_ctx.var`）
- `${变量名}` → 自定义变量（或者插件变量，`fetch_vars` 提取的变量或响应内置变量）

## 基本格式

表达式是一个数组，每个条件可以是三元素或四元素数组：

- **三元素格式**：`["变量名", "操作符", "值"]`
- **四元素格式**：`["变量名", "!", "操作符", "值"]`（使用 `!` 反转操作符）

```json
["变量名", "操作符", "值"]
```

或

```json
["变量名", "!", "操作符", "值"]
```

## 支持的操作符

### 比较操作符

| 操作符 | 说明 | 示例 |
|--------|------|------|
| `==` | 等于 | `["$method", "==", "POST"]` |
| `~=` | 不等于 | `["${error_code}", "~=", ""]` |
| `>` | 大于 | `["${upstream_status}", ">", 199]` |
| `>=` | 大于等于 | `["${upstream_status}", ">=", 200]` |
| `<` | 小于 | `["${upstream_status}", "<", 300]` |
| `<=` | 小于等于 | `["${upstream_status}", "<=", 299]` |

### 正则匹配操作符

| 操作符 | 说明 | 示例 |
|--------|------|------|
| `~~` | 正则匹配（大小写敏感） | `["$uri", "~~", "^/api/"]` |
| `~*` | 正则匹配（忽略大小写） | `["$uri", "~*", "^/API/"]` |
| `!` + `~~` | 正则不匹配（大小写敏感） | `["$uri", "!", "~~", "^/admin"]` |
| `!` + `~*` | 正则不匹配（忽略大小写） | `["$uri", "!", "~*", "^/ADMIN"]` |

### 成员操作符

| 操作符 | 说明 | 示例 |
|--------|------|------|
| `in` | 在数组中 | `["$method", "in", ["GET", "POST"]]` |
| `has` | 数组包含元素（左侧值必须是数组） | `["${roles}", "has", "admin"]` |
| `!` + `in` | 不在数组中 | `["$method", "!", "in", ["DELETE", "PUT"]]` |
| `!` + `has` | 数组不包含元素 | `["${roles}", "!", "has", "guest"]` |

### IP 匹配操作符

| 操作符 | 说明 | 示例 |
|--------|------|------|
| `ipmatch` | IP 匹配（支持 CIDR，值可以是单个字符串或数组） | `["$remote_addr", "ipmatch", ["10.0.0.0/8"]]` 或 `["$remote_addr", "ipmatch", "10.0.0.0/8"]` |
| `!` + `ipmatch` | IP 不匹配 | `["$remote_addr", "!", "ipmatch", ["192.168.0.0/16"]]` |

### 反转操作符

`!` 操作符用于反转相邻的操作符，必须放在操作符之前作为表达式的第二个元素：

| 格式 | 说明 | 示例 |
|------|------|------|
| `["变量名", "!", "操作符", "值"]` | 反转操作符的结果 | `["$uri", "!", "~~", "^/admin"]` |

**注意**：表达式可以是三元素或四元素数组：
- 三元素：`["变量名", "操作符", "值"]`
- 四元素：`["变量名", "!", "操作符", "值"]`（使用 `!` 反转操作符）

## 逻辑组合

### 单个条件

```json
["$method", "==", "POST"]
```

或

```json
["${upstream_status}", "==", 200]
```

### AND 关系

使用 `"AND"` 作为数组第一个元素，后面跟多个条件：

```json
["AND",
  ["${upstream_status}", ">=", 200],
  ["${upstream_status}", "<", 300],
  ["${user_id}", "~=", ""]
]
```

等价于：`upstream_status >= 200 AND upstream_status < 300 AND user_id ~= ""`

### OR 关系

使用 `"OR"` 作为数组第一个元素，后面跟多个条件：

```json
["OR",
  ["${upstream_status}", "==", 200],
  ["${upstream_status}", "==", 201],
  ["${upstream_status}", "==", 204]
]
```

等价于：`upstream_status == 200 OR upstream_status == 201 OR upstream_status == 204`

### !AND 关系

使用 `"!AND"` 作为数组第一个元素，表示"至少有一个条件为假"：

```json
["!AND",
  ["${upstream_status}", "==", 200],
  ["${user_id}", "~=", ""]
]
```

等价于：`NOT (upstream_status == 200 AND user_id ~= "")`，即至少有一个条件为假时返回 true

### !OR 关系

使用 `"!OR"` 作为数组第一个元素，表示"所有条件都为假"：

```json
["!OR",
  ["${upstream_status}", "==", 200],
  ["${upstream_status}", "==", 201]
]
```

等价于：`NOT (upstream_status == 200 OR upstream_status == 201)`，即所有条件都为假时返回 true

### 嵌套组合

AND 和 OR 可以嵌套使用：

```json
["OR",
  ["AND",
    ["${upstream_status}", ">=", 200],
    ["${upstream_status}", "<", 300]
  ],
  ["${upstream_status}", "==", 302]
]
```

等价于：`(upstream_status >= 200 AND upstream_status < 300) OR upstream_status == 302`

### 复杂嵌套示例

```json
["AND",
  ["$method", "==", "POST"],
  ["OR",
    ["$uri", "~~", "^/api/login"],
    ["$uri", "~~", "^/api/auth"]
  ],
  ["${upstream_status}", "==", 200]
]
```

等价于：`method == "POST" AND (uri ~~ "^/api/login" OR uri ~~ "^/api/auth") AND upstream_status == 200`

## 可用变量

### 系统变量（使用 `$` 引用）

来自 `api_ctx.var`，用于子路由匹配（`vars`）和子请求条件执行（`exec_expr`）：

- `$remote_addr` - 客户端 IP
- `$uri` - 请求 URI
- `$method` - 请求方法
- `$host` - 请求 Host
- `$http_xxx` - 请求头，例如 `$http_user_agent`、`$http_authorization`
- `$arg_xxx` - 查询参数
- `$post_arg_xxx` - POST 表单参数
- `$cookie_xxx` - Cookie 值
- `$uri_ext` - URI 扩展名

完整的请求变量列表见 [变量.md](变量.md)。

### 自定义变量（使用 `${}` 引用）

用于 `success_expr` 和 `passwd_failed_expr`：

#### 响应内置变量

由 `fetch_vars`（exposure_login）或子请求响应（exposure_user）自动设置：

- `${upstream_status}` - 上游（应用）响应状态码
- `${header_xxx_xxx}` - 响应头，格式为 `header_<小写header名>`，`-` 替换为 `_`
  - 例如：`${header_content_type}`、`${header_set_cookie}`、`${header_x_auth_token}`

#### fetch_vars 提取的变量

通过 `fetch_vars` 配置提取的任意变量，必须使用 `${变量名}` 格式引用。

## 使用场景示例

### 子路由匹配（vars）

```json
{
  "routes": [
    {
      "uri": "/api/*",
      "methods": ["POST"],
      "vars": [
        ["$http_user_agent", "~~", "Mobile"],
        ["$method", "==", "POST"]
      ]
    }
  ]
}
```

### 子请求条件执行（exec_expr）

```json
{
  "sub_requests": [
    {
      "name": "mobile_auth",
      "exec_expr": [["$http_user_agent", "~~", "Mobile"]],
      "uri": "/api/mobile/check"
    }
  ]
}
```

### 登录成功判定（success_expr）

```json
{
  "success_expr": [
    ["${upstream_status}", "==", 200],
    ["${user_id}", "~=", ""]
  ]
}
```

### 账密失败判定（passwd_failed_expr）

```json
{
  "passwd_failed_expr": [
    ["${upstream_status}", "==", 401],
    ["${error_code}", "==", "INVALID_PASSWORD"]
  ]
}
```

### 判定 HTTP 2xx 成功

```json
{
  "success_expr": ["AND",
    ["${upstream_status}", ">=", 200],
    ["${upstream_status}", "<", 300]
  ]
}
```

### 判定 JSON 响应且包含 user_id

```json
{
  "success_expr": ["AND",
    ["${upstream_status}", "==", 200],
    ["${header_content_type}", "~~", "application/json"],
    ["${user_id}", "~=", ""]
  ]
}
```

### 判定多种失败情况

```json
{
  "passwd_failed_expr": ["OR",
    ["${upstream_status}", "==", 401],
    ["${upstream_status}", "==", 403],
    ["${error_code}", "in", ["INVALID_PASSWORD", "ACCOUNT_LOCKED", "PASSWORD_EXPIRED"]]
  ]
}
```

### 根据 User-Agent 判定移动端（子路由）

```json
{
  "vars": [["$http_user_agent", "~~", "Mobile"]]
}
```

### 根据请求方法判定（子路由）

```json
{
  "vars": [["$method", "in", ["POST", "PUT"]]]
}
```

### IP 白名单判定（子路由）

```json
{
  "vars": [["$remote_addr", "ipmatch", ["10.0.0.0/8", "172.16.0.0/12", "192.168.0.0/16"]]]
}
```

或使用单个 IP/CIDR：

```json
{
  "vars": [["$remote_addr", "ipmatch", "10.0.0.0/8"]]
}
```

### 排除特定路径（子路由）

```json
{
  "vars": ["AND",
    ["$uri", "!", "~~", "^/health"],
    ["$uri", "!", "~~", "^/metrics"]
  ]
}
```

### 复杂条件：POST 登录请求且成功

```json
{
  "success_expr": ["AND",
    ["${upstream_status}", "==", 200],
    ["${user_id}", "~=", ""]
  ]
}
```

**注意**：`success_expr` 中不能直接使用系统变量（如 `$method`、`$uri`），如需使用，需先在 `fetch_vars` 中提取。

## 注意事项

1. **变量引用格式**：
   - 系统变量（`vars`、`exec_expr`）使用 `$变量名` 格式
   - 自定义变量（`success_expr`、`passwd_failed_expr`）使用 `${变量名}` 格式
2. **表达式格式**：
   - 三元素：`["变量名", "操作符", "值"]`
   - 四元素：`["变量名", "!", "操作符", "值"]`（使用 `!` 反转操作符）
3. **字符串值需要引号**：值为字符串时需要用引号包裹
4. **数组值用方括号**：`in`、`has` 操作符的值需要用数组格式；`ipmatch` 的值可以是单个字符串或数组
5. **正则语法**：正则表达式使用 PCRE 语法
6. **数值比较**：比较数值时，确保值的类型正确（数字不要加引号）
7. **逻辑操作符位置**：`"AND"`、`"OR"`、`"!AND"`、`"!OR"` 必须作为数组的**第一个元素**
8. **反转操作符**：使用 `!` 操作符时，必须作为表达式的第二个元素，格式为 `["变量名", "!", "操作符", "值"]`
9. **`has` 操作符限制**：`has` 操作符只支持数组类型，左侧值必须是数组，不支持字符串
10. **`!=` 操作符**：不支持 `!=` 操作符，请使用 `~=` 代替