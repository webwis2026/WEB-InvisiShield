# 快速开始

本文档帮助您快速配置Web隐身盾暴露面收敛插件，实现统一身份认证和访问控制。

## 配置流程概览

```
1. 分析应用认证机制
   ├─ 登录接口（URI、方法、参数格式）
   ├─ 认证凭据（cookie/header 名称）
   └─ 登录成功标识（响应码、响应体字段）

2. 分析用户信息获取接口
   └─ 找到可验证登录状态并获取用户信息的接口

3. 分析白名单接口
   └─ 梳理无需认证即可访问的接口

4. 配置核心插件
   ├─ exposure_session（会话管理）
   ├─ exposure_user（用户信息获取）
   ├─ exposure_auth（请求认证）
   └─ exposure_login（登录接口 Hook）

5. 配置防护插件
   ├─ ua_restriction（UA 限制）
   ├─ ip_restriction（IP 限制）
   ├─ passwd_capture（账密捕获）
   ├─ passwd_restriction（弱密码检测）
   └─ passwd_bruteforce（暴力破解防护）

6. 配置白名单
   └─ 子路由白名单，正则白名单

7. 测试验证
   └─ 验证登录、认证、白名单等功能
```

## 配置结构

### 基本配置结构

```json
{
  "plugins": [...],
  "sub_routes": [...],
  "plugin_groups": {...},
  "plugin_confs": {...}
}
```

| 配置项 | 说明 |
|--------|------|
| `plugins` | 应用主插件组，直接定义插件列表，处理除特殊接口外的所有请求 |
| `plugin_group_id` | 引用已定义的插件组 ID，与 `plugins` **二选一**，`plugins` 优先级更高 |
| `sub_routes` | 子路由配置，用于特殊接口（如登录接口）使用不同的插件组 |
| `plugin_groups` | 应用作用域的插件组定义，可被子路由或 `plugin_group_id` 引用 |
| `plugin_confs` | 应用作用域的插件配置，插件组内只写插件名时从此处查找配置 |

**注意**：`plugins` 和 `plugin_group_id` 二选一配置：
- `plugins`：直接在应用配置中定义插件列表
- `plugin_group_id`：引用 `plugin_groups` 中定义的插件组，适合插件组复用场景
- 如果同时配置，`plugins` 优先级更高


## 配置说明

### 1. 主插件组（plugins）

主插件组处理除特殊接口外的所有请求，按执行顺序包括：

- **基础插件**：`redirect`、`client_ip` - 请求重定向和客户端 IP 获取
- **防护插件**：`uri_blocker`、`ua_restriction`、`ip_restriction` - SQL 注入、UA 限制、IP 限制
- **白名单插件**：`uri_bypass` - 正则白名单，跳过静态资源等
- **账密捕获**：`passwd_capture` - 捕获登录页面的账密
- **认证插件**：`exposure_auth` - 入口认证，验证用户身份
- **代理和压缩**：`proxy_rewrite`、`unzip`、`response_rewrite`、`gzip` - 请求代理和响应处理
- **日志插件**：`app_logger` - 应用日志记录

### 2. 子路由配置（sub_routes）

#### 2.1 登录接口子路由

为登录接口（`POST /login`）配置专门的插件组：

- **防护插件**：`uri_blocker`、`ua_restriction`、`ip_restriction` - 基础防护
- **账密捕获**：`passwd_capture`（`get: true`）- 从请求中提取账密
- **弱密码检测**：`passwd_restriction` - 检测弱密码
- **暴力破解防护**：`passwd_bruteforce` - 限制登录频率
- **登录处理**：`exposure_login` - Hook 登录接口，判定登录成功/失败

**关键配置**：

```json
{
  "name": "exposure_login",
  "conf": {
    "fetch_vars": {
      "user_id": {
        "source": "request_body",
        "field": "user",
        "parser": "json"
      },
      "status_code": {
        "source": "response_body",
        "field": "statusCode",
        "parser": "json"
      }
    },
    "success_expr": [
      ["${upstream_status}", "==", 200],
      ["${message}", "==", "Logged in"]
    ],
    "save_session": true
  }
}
```

#### 2.2 登录页子路由

为登录页面（`GET /login`）配置插件组，主要用于注入账密捕获 JS：

- **防护插件**：基础防护
- **账密捕获**：`passwd_capture`（`set: true`）- 注入 JS 脚本到登录页面

### 3. 插件配置（plugin_confs）

#### 3.1 exposure_session（会话管理）

**重要**：`exposure_session` 是特殊插件，必须在 `plugin_confs` 中配置。

```json
{
  "exposure_session": {
    "key_name": "cookie_WISID",
  }
}
```

- `key_name`：认证 key 名称，可以是 cookie 或 header（如 `cookie_WISID`、`header_X-Auth-Token`）

#### 3.2 exposure_user（用户信息获取）

当本地 session 匹配失败时，通过子请求获取用户信息：

```json
{
  "exposure_user": {
    "key_name": "cookie_grafana_session",
    "sub_requests": [
      {
        "name": "get_user",
        "uri": "/api/user",
        "method": "GET",
        "fetch_vars": {
          "user_id": {
            "source": "response_body",
            "field": "login",
            "parser": "json"
          }
        },
        "success_expr": [
          ["${upstream_status}", "==", 200]
        ]
      }
    ],
    "user_id_var": "${get_user.user_id}",
    "user_name_var": "${get_user.user_name}"
  }
}
```

**配置要点**：
- `key_name`：应用自身的认证 key（如 `cookie_grafana_session`）
- `sub_requests`：子请求配置，用于验证登录状态并获取用户信息
- `user_id_var` / `user_name_var`：从子请求响应中提取用户信息的变量引用

#### 3.3 uri_bypass（正则白名单）

配置无需认证即可访问的接口：

```json
{
  "uri_bypass": {
    "filters": [
      "/public/.*\\.(js|css|png|jpg|jpeg|gif|svg|woff|woff2|ttf|eot|ico|map)$",
      "^(/|/login|/logout)$"
    ]
  }
}
```

**注意**：`uri_bypass` 必须配置在 `exposure_auth` **之前**，否则白名单不生效。

## 分步配置指南

### 步骤 1：配置 exposure_session

在 `plugin_confs` 中配置会话管理：

```json
{
  "plugin_confs": {
    "exposure_session": {
      "key_name": "cookie_WISID"
    }
  }
}
```

### 步骤 2：配置 exposure_user

找到应用的用户信息接口（如 `/api/user`、`/api/userinfo`），配置子请求：

```json
{
  "plugin_confs": {
    "exposure_user": {
      "key_name": "cookie_应用session名称",
      "sub_requests": [
        {
          "name": "get_user",
          "uri": "/api/user",
          "method": "GET",
          "fetch_vars": {
            "user_id": {
              "source": "response_body",
              "field": "data.id",  // 根据实际响应结构调整
              "parser": "json"
            },
            "user_name": {
              "source": "response_body",
              "field": "data.name",  // 根据实际响应结构调整
              "parser": "json"
            }
          },
          "success_expr": [
            ["${upstream_status}", "==", 200]
          ]
        }
      ],
      "user_id_var": "${get_user.user_id}",
      "user_name_var": "${get_user.user_name}"
    }
  }
}
```

**如何确定字段路径**：
- 查看接口响应示例，确定 `user_id` 和 `user_name` 的 JSON 路径
- 例如响应为 `{"data": {"id": "123", "name": "admin"}}`，则路径为 `data.id` 和 `data.name`
- 详细路径语法见 [path-syntax.md](path-syntax.md)

### 步骤 3：配置 exposure_auth

在主插件组中添加认证插件：

```json
{
  "plugins": [
    "redirect",
    "client_ip",
    "uri_bypass",  // 必须在 exposure_auth 之前
    {
      "name": "exposure_auth",
      "conf": {
        "log_unauthed": true,
        "response_code": 403,
        "response_msg": "禁止访问"
      }
    },
    "app_logger"
  ]
}
```

### 步骤 4：配置登录接口子路由

为登录接口配置专门的插件组：

```json
{
  "sub_routes": [
    {
      "name": "登录接口",
      "plugins": [
        "redirect",
        "client_ip",
        {
          "name": "exposure_login",
          "conf": {
            "fetch_vars": {
              "user_id": {
                "source": "request_body",
                "field": "username",  // 根据实际请求参数调整
                "parser": "json"
              },
              "status_code": {
                "source": "response_body",
                "field": "code",  // 根据实际响应结构调整
                "parser": "json"
              }
            },
            "user_id_var": "${user_id}",
            "success_expr": [
              ["${upstream_status}", "==", 200]
            ],
            "save_session": true
          }
        }
      ],
      "routes": [
        {
          "uri": "/api/login",  // 根据实际登录接口调整
          "methods": ["POST"]
        }
      ]
    }
  ]
}
```

**如何确定登录成功条件**：
- 查看登录接口的响应，确定成功标识
- 常见情况：
  - 响应码为 200
  - 响应体包含特定字段（如 `"success": true`）
  - 响应体包含用户信息
- 使用 `success_expr` 配置判定条件，详细语法见 [条件表达式.md](条件表达式.md)

### 步骤 5：配置白名单

根据应用情况配置白名单：

**方式一：子路由白名单（推荐）**

```json
{
  "sub_routes": [
    {
      "name": "白名单接口",
      "plugins": [],
      "routes": [
        {
          "uri": "/health",
          "methods": ["GET"]
        },
        {
          "uri": "/static/*"
        }
      ]
    }
  ]
}
```

**方式二：正则白名单（uri_bypass）**

```json
{
  "plugin_confs": {
    "uri_bypass": {
      "filters": [
        "^/health$",
        "^/static/.*",
        "\\.(css|js|png|jpg)$"
      ]
    }
  }
}
```

详细配置见 [白名单.md](白名单.md)。



## 测试验证

### 1. 测试登录接口

```bash
# 测试登录接口
curl -X POST http://your-app/login \
  -H "Content-Type: application/json" \
  -d '{"user": "admin", "password": "password123"}'
```

**预期结果**：
- 登录成功：返回 200，设置 `WISID` cookie
- 登录失败：返回 401 或其他错误码

### 2. 测试认证

```bash
# 未登录访问受保护接口
curl http://your-app/api/protected

# 预期：返回 403 或重定向到登录页

# 携带 WISID cookie 访问
curl http://your-app/api/protected \
  -H "Cookie: WISID=your-wisid-value"

# 预期：正常返回数据
```

### 3. 测试白名单

```bash
# 访问白名单接口（无需认证）
curl http://your-app/health
curl http://your-app/static/style.css

# 预期：正常返回，不要求认证
```

### 4. 测试用户信息获取

当本地 session 不存在时，`exposure_user` 会发起子请求获取用户信息。可以通过日志查看子请求的执行情况。

## 常见问题

### 1. 认证失败，返回 403

**可能原因**：
- `exposure_session` 未配置或配置错误
- `exposure_user` 子请求失败
- `key_name` 配置错误

**排查步骤**：
1. 检查 `plugin_confs.exposure_session` 配置
2. 检查 `plugin_confs.exposure_user` 配置
3. 查看日志，确认子请求是否成功

### 2. 登录接口无法保存会话

**可能原因**：
- `exposure_login` 的 `success_expr` 配置错误
- `save_session` 未设置为 `true`
- `exposure_session` 未配置

**排查步骤**：
1. 检查 `success_expr` 是否匹配登录成功的条件
2. 确认 `save_session: true`
3. 检查 `exposure_session` 配置

### 3. 白名单不生效

**可能原因**：
- `uri_bypass` 配置在 `exposure_auth` 之后
- 正则表达式匹配错误

**排查步骤**：
1. 确认 `uri_bypass` 在插件组中的位置（必须在 `exposure_auth` 之前）
2. 测试正则表达式是否正确匹配 URI

### 4. 无法提取用户信息

**可能原因**：
- `fetch_vars` 字段路径配置错误
- 响应格式与配置不匹配

**排查步骤**：
1. 查看实际响应内容
2. 检查 JSON 路径是否正确（使用 [path-syntax.md](path-syntax.md) 验证）
3. 查看日志中的变量提取结果

## 参考文档

- [README.md](readme.md) - 整体架构和配置说明
- [exposure_auth.md](exposure_auth.md) - 认证插件详细配置
- [exposure_login.md](exposure_login.md) - 登录插件详细配置
- [exposure_user.md](exposure_user.md) - 用户信息获取插件详细配置
- [exposure_session.md](exposure_session.md) - 会话管理插件详细配置
- [白名单.md](白名单.md) - 白名单配置说明
- [子路由.md](子路由.md) - 子路由配置说明
- [变量.md](变量.md) - 变量引用和 fetch_vars 配置
- [条件表达式.md](条件表达式.md) - 表达式语法说明
- [path-syntax.md](path-syntax.md) - JSON/XML 路径提取语法

## 下一步

配置完成后，建议：

1. **监控日志**：关注认证失败、登录异常等日志
2. **性能优化**：根据实际情况调整缓存、超时等参数
3. **安全加固**：配置更多防护规则，如 IP 白名单、UA 限制等
4. **功能扩展**：根据需要添加更多插件，如审计日志、响应重写等
