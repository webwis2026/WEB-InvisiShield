# 子路由配置文档

## 概述

子路由用于为应用的特殊接口（如登录接口、白名单接口）配置不同的插件组。子路由使用 `resty.radixtree`（基数树）进行高效的路径匹配。

**注意**：由于主应用已经根据 Host 进行了匹配，子路由匹配时**不再进行 Host 匹配**，仅匹配 URI、HTTP 方法和自定义条件。

## 配置结构

```json
{
  "sub_routes": [
    {
      "name": "子路由名称",
      "desc": "子路由功能描述",
      "plugins": [...],
      "plugin_group_id": "插件组ID, 引用已定义的插件组（与 plugins 二选一）",
      "routes": [
        {
          "uri": "/api/login",
          "uris": ["/api/login", "/api/auth"],
          "methods": ["POST"],
          "vars": [...]
        }
      ]
    }
  ]
}
```

## 配置字段说明

### 子路由配置

| 字段 | 类型 | 必需 | 说明 |
|------|------|------|------|
| `name` | string | 是 | 子路由名称，用于标识和日志 |
| `plugins` | array | 二选一 | 直接定义插件列表 |
| `plugin_group_id` | string | 二选一 | 引用 `plugin_groups` 中定义的插件组 |
| `routes` | array | 是 | 路由匹配规则数组 |

**注意**：`plugins` 和 `plugin_group_id` 必须配置其中之一，否则子路由无效。

### 路由匹配规则

| 字段 | 类型 | 必需 | 说明 |
|------|------|------|------|
| `uri` | string | 二选一 | 匹配的 URI 路径 |
| `uris` | array | 二选一 | 匹配的多个 URI 路径 |
| `methods` | array | 否 | 匹配的 HTTP 方法，如 `["GET", "POST"]` |
| `vars` | array | 否 | 额外的匹配条件，使用 lua-resty-expr 语法 |

## URI 匹配规则

子路由使用 `resty.radixtree` 进行 URI 匹配，支持以下模式：

### 精确匹配

```json
{
  "uri": "/api/login"
}
```

仅匹配 `/api/login`。

### 前缀匹配

```json
{
  "uri": "/api/*"
}
```

匹配 `/api/` 下的所有路径，如 `/api/login`、`/api/user/info` 等。

### 参数匹配

```json
{
  "uri": "/api/user/:id"
}
```

匹配 `/api/user/123`、`/api/user/abc` 等，`:id` 为路径参数。

### 多路径匹配

```json
{
  "uris": ["/api/login", "/api/auth", "/login"]
}
```

匹配多个 URI 路径。

## 方法匹配

通过 `methods` 字段指定允许的 HTTP 方法：

```json
{
  "uri": "/api/login",
  "methods": ["POST"]
}
```

- 不配置 `methods` 时，匹配所有 HTTP 方法
- 配置后仅匹配指定的方法

支持的方法：`GET`、`POST`、`PUT`、`DELETE`、`PATCH`、`HEAD`、`OPTIONS`

## 条件匹配（vars）

使用 `vars` 字段添加额外的匹配条件：
 表达式语法参考 [lua-resty-expr.md](lua-resty-expr.md)。

vars 变量来源：`vars` 中参与匹配的变量为系统变量，必须使用 `$变量名` 格式引用，常用变量如：
- `$arg_xxx` - URL 查询参数
- `$http_xxx` - 请求头（如 `$http_user_agent`）
- `$cookie_xxx` - Cookie 值
- `$remote_addr` - 客户端 IP
- `$uri`、`$host`、`$method` 等 nginx 内置变量

详细变量列表见 [变量.md](变量.md)。

### 根据查询参数匹配

```json
{
  "uri": "/api/login",
  "methods": ["POST"],
  "vars": [
    ["$arg_type", "==", "mobile"]
  ]
}
```

仅匹配 `/api/login?type=mobile` 的 POST 请求。

### 根据请求头匹配

```json
{
  "uri": "/api/login",
  "vars": [
    ["$http_x_client_type", "==", "app"]
  ]
}
```

仅匹配请求头 `X-Client-Type: app` 的请求。

### 根据 Cookie 匹配

```json
{
  "uri": "/api/user",
  "vars": [
    ["$cookie_session", "~~", "^[a-zA-Z0-9]+$"]
  ]
}
```

### 多条件组合

```json
{
  "uri": "/api/login",
  "methods": ["POST"],
  "vars": ["AND",
    ["$arg_type", "==", "mobile"],
    ["$http_user_agent", "~~", "Android"]
  ]
}
```

匹配移动端 Android 设备的登录请求。

## 使用示例

### 示例 1：登录接口子路由

```json
{
  "name": "登录接口",
  "plugin_group_id": "login_plugins",
  "routes": [
    {
      "uri": "/api/login",
      "methods": ["POST"]
    },
    {
      "uri": "/api/auth/login",
      "methods": ["POST"]
    }
  ]
}
```

### 示例 2：移动端登录接口

```json
{
  "name": "移动端登录",
  "plugin_group_id": "mobile_login_plugins",
  "routes": [
    {
      "uri": "/api/login",
      "methods": ["POST"],
      "vars": [
        ["$arg_platform", "==", "mobile"]
      ]
    },
    {
      "uri": "/api/mobile/login",
      "methods": ["POST"]
    }
  ]
}
```

### 示例 3：白名单接口（跳过所有插件）

```json
{
  "name": "白名单接口",
  "plugins": [],
  "routes": [
    {
      "uri": "/health",
      "methods": ["GET"]
    },
    {
      "uri": "/metrics",
      "methods": ["GET"]
    },
    {
      "uris": ["/favicon.ico", "/robots.txt"]
    }
  ]
}
```

### 示例 4：API 前缀匹配

```json
{
  "name": "公开API",
  "plugins": ["rate_limit", "cors"],
  "routes": [
    {
      "uri": "/public/*",
      "methods": ["GET"]
    }
  ]
}
```

### 示例 5：带参数的路由

```json
{
  "name": "用户信息接口",
  "plugin_group_id": "user_plugins",
  "routes": [
    {
      "uri": "/api/user/:id",
      "methods": ["GET", "PUT"]
    },
    {
      "uri": "/api/user/:id/profile",
      "methods": ["GET"]
    }
  ]
}
```

## 匹配优先级

1. **子路由优先**：请求先匹配子路由，匹配成功则使用子路由的插件组
2. **精确匹配优先**：精确匹配的路由优先于通配符匹配
3. **先定义优先**：相同匹配度的路由，先定义的优先

## 注意事项

1. **必须配置插件**：`plugins` 或 `plugin_group_id` 必须配置其中之一，否则子路由无效并记录错误日志

2. **必须配置路由规则**：`routes` 数组必须存在且包含有效的路由配置

3. **不进行 Host 匹配**：子路由不再进行 Host 匹配，因为主应用已经根据 Host 匹配

4. **空插件组**：设置 `"plugins": []` 可以跳过所有插件处理，用于白名单接口

5. **路由缓存**：子路由使用 LRU 缓存（TTL 3600秒，最大 1024 条），配置更新后会自动刷新

6. **vars 语法**：条件匹配使用 lua-resty-expr 语法，详见 [条件表达式.md](条件表达式.md)。**注意**：`vars` 中使用系统变量必须使用 `$变量名` 格式引用（如 `$arg_type`、`$http_user_agent`）。

## 调试

子路由匹配结果会记录到日志：

- 创建成功：`create sub-router succ, version: xxx`
- 配置错误：`invalid sub-route: xxx` 或 `plugins not configured`

匹配成功后，`api_ctx.matched_sub_route` 会指向匹配的子路由配置。

