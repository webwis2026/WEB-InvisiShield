# 零改造引擎插件合规性审计清单

**版本**：1.0  
**依据文档**：readme.md、5分钟编写应用插件.md、应用插件文档.md、白名单.md、uri_bypass.md、exposure_session.md、exposure_user.md、exposure_auth.md、exposure_login.md、正则表达式性能优化指南.md

**自动化校验**：
- **JSON Schema**：`plugin-config.schema.json`（结构校验）
- **校验脚本**：`plugin-validate.py` 或 `plugin-validate.js`（结构 + 业务规则）

---

## 一、顶层结构

| 序号 | 检查项 | 要求 | 合规 | 备注 |
|------|--------|------|:----:|------|
| 1.1 | desc 块 | 必须存在顶层 `desc` 对象 | ☐ | 元数据不得放在 gw_configures 内 |
| 1.2 | user_configures | 可选，若存在则需符合格式 | ☐ | |
| 1.3 | gw_configures | 必须存在，包含 plugins/sub_routes/plugin_confs | ☐ | |

---

## 二、desc 元信息（必填字段）

| 序号 | 字段 | 类型 | 必填 | 合规 | 说明 |
|------|------|------|:----:|:----:|------|
| 2.1 | plugin_name | string | 是 | ☐ | 应用插件名称 |
| 2.2 | plugin_for_app_name | string | 是 | ☐ | 目标应用名称 |
| 2.3 | plugin_for_app_version | string | 是 | ☐ | 目标应用版本 |
| 2.4 | plugin_version | string | 是 | ☐ | 应用插件版本 |
| 2.5 | plugin_need_engine_version | string | 是 | ☐ | 所需引擎最低版本 |
| 2.6 | plugin_author | string | 是 | ☐ | 作者 |
| 2.7 | plugin_description | string | 是 | ☐ | 描述信息 |
| 2.8 | plugin_last_updated | string | 是 | ☐ | 最后更新日期 |

---

## 三、gw_configures 结构

### 3.1 主插件组（plugins）

| 序号 | 检查项 | 要求 | 合规 | 备注 |
|------|--------|------|:----:|------|
| 3.1.1 | plugins 或 plugin_group_id | 二选一，plugins 优先 | ☐ | 不得同时使用 plugin_groups |
| 3.1.2 | 插件格式 | 支持 `"name"` 或 `{"name":"x","conf":{}}` | ☐ | |
| 3.1.3 | 元数据位置 | 版本信息不得在 gw_configures 根节点 | ☐ | 应全部在 desc 中 |

### 3.2 插件执行顺序（含 exposure_auth 时）

| 序号 | 检查项 | 要求 | 合规 | 备注 |
|------|--------|------|:----:|------|
| 3.2.1 | uri_blocker | 必须在 exposure_auth **之前** | ☐ | 防护优先于认证 |
| 3.2.2 | request_blocker | 必须在 exposure_auth **之前** | ☐ | 防护优先于认证 |
| 3.2.3 | uri_bypass | 必须在 exposure_auth **之前** | ☐ | 白名单跳过认证 |
| 3.2.4 | 推荐顺序 | redirect → client_ip → uri_blocker → request_blocker → uri_bypass → ... → exposure_auth | ☐ | 参考 grafana.json |

### 3.3 子路由（sub_routes）

| 序号 | 检查项 | 要求 | 合规 | 备注 |
|------|--------|------|:----:|------|
| 3.3.1 | 插件引用方式 | 使用内联 `plugins` 数组 | ☐ | **禁用** plugin_group_id |
| 3.3.2 | plugin_groups | 不得使用 | ☐ | 新规范已废弃 |
| 3.3.3 | 子路由必填字段 | name、plugins 或 plugin_group_id、routes | ☐ | plugins 与 plugin_group_id 二选一 |
| 3.3.4 | routes 配置 | 至少包含 uri/uris、可选 methods、vars | ☐ | |

---

## 四、白名单与防护插件

### 4.1 白名单插件

| 序号 | 检查项 | 要求 | 合规 | 备注 |
|------|--------|------|:----:|------|
| 4.1.1 | 白名单插件名 | 使用 `uri_bypass` | ☐ | **禁用** regex_whiteuri |
| 4.1.2 | uri_bypass 配置格式 | `{"filters": ["^/path$", ...]}` | ☐ | filters 为**正则字符串数组** |
| 4.1.3 | 废弃格式 | 不得使用 `{"filters":[{"regex_uris":[]}]}` | ☐ | regex_whiteuri 旧格式 |

### 4.2 防护插件

| 序号 | 检查项 | 要求 | 合规 | 备注 |
|------|--------|------|:----:|------|
| 4.2.1 | uri_blocker | 含 exposure_auth 时建议配置 | ☐ | 用于 URI 攻击检测 |
| 4.2.2 | request_blocker | 含 exposure_auth 时建议配置 | ☐ | 用于请求体攻击检测 |

---

## 五、特殊插件配置

### 5.1 exposure_session

| 序号 | 检查项 | 要求 | 合规 | 备注 |
|------|--------|------|:----:|------|
| 5.1.1 | 配置位置 | 仅在 `plugin_confs` 中 | ☐ | **不得**在主 plugins 数组 |
| 5.1.2 | 键名 | `"exposure_session"` | ☐ | |
| 5.1.3 | key_name | 必填，如 cookie_WISID、cookie_xxx、http_xxx | ☐ | |

### 5.2 exposure_user

| 序号 | 检查项 | 要求 | 合规 | 备注 |
|------|--------|------|:----:|------|
| 5.2.1 | 配置位置 | 仅在 `plugin_confs` 中 | ☐ | **不得**在 plugins 数组 |
| 5.2.2 | 键名 | `"exposure_user"` | ☐ | |
| 5.2.3 | key_name | 必填，与 exposure_session 或应用 cookie/header 对应 | ☐ | |
| 5.2.4 | sub_requests | 必填，至少一个子请求 | ☐ | |
| 5.2.5 | user_id_var / user_name_var | 必填，引用子请求提取的变量 | ☐ | 格式 `${get_user.xxx}` |

### 5.3 exposure_auth（含登录场景时）

| 序号 | 检查项 | 要求 | 合规 | 备注 |
|------|--------|------|:----:|------|
| 5.3.1 | 配置方式 | 主 plugins 中内联或 plugin_confs | ☐ | |
| 5.3.2 | 依赖 | 需配合 exposure_session、exposure_user | ☐ | save_session 时需 exposure_session |

### 5.4 exposure_login（登录子路由）

| 序号 | 检查项 | 要求 | 合规 | 备注 |
|------|--------|------|:----:|------|
| 5.4.1 | 配置位置 | 登录子路由的 plugins 中 | ☐ | |
| 5.4.2 | fetch_vars | 需配置请求/响应提取变量 | ☐ | |
| 5.4.3 | success_expr | 必填，登录成功判定 | ☐ | |
| 5.4.4 | passwd_failed_expr | 建议配置，账密失败判定 | ☐ | |
| 5.4.5 | save_session | 登录成功时是否保存会话 | ☐ | |

---

## 六、user_configures

| 序号 | 检查项 | 要求 | 合规 | 备注 |
|------|--------|------|:----:|------|
| 6.1 | json_path | 必须指向 gw_configures 内有效路径 | ☐ | |
| 6.2 | 数组索引 | 使用 plugins[N] 时索引需与当前 plugins 顺序一致 | ☐ | 增删插件后需同步更新 |
| 6.3 | type | 支持 int、text、bool、json、select、mult_select | ☐ | |
| 6.4 | select/mult_select | 需配置 options、value_type | ☐ | |
| 6.5 | label/lable | 规范为 label，引擎可能兼容 lable | ☐ | |

---

## 七、正则表达式（可选优化）

| 序号 | 检查项 | 要求 | 合规 | 备注 |
|------|--------|------|:----:|------|
| 7.1 | 避免回溯灾难 | 禁用嵌套量词如 `(a+)+` | ☐ | 见正则表达式性能优化指南 |
| 7.2 | 贪婪量词 | 慎用 `.+`、`.*`，优先 `[^x]+` | ☐ | |
| 7.3 | uri_bypass filters | 建议使用锚点 `^`、`$` | ☐ | |

---

## 八、禁止项

| 序号 | 禁止项 | 说明 |
|------|--------|------|
| 8.1 | regex_whiteuri | 已废弃，改用 uri_bypass |
| 8.2 | plugin_group_id + plugin_groups | 新规范使用子路由内联 plugins |
| 8.3 | exposure_session 在主 plugins | 必须在 plugin_confs |
| 8.4 | exposure_user 在 plugins | 必须在 plugin_confs |
| 8.5 | uri_bypass 在 exposure_auth 之后 | 白名单无法生效 |
| 8.6 | uri_blocker/request_blocker 在 exposure_auth 之后 | 违反防护优先原则 |

---

## 九、审计使用说明

1. **逐项勾选**：对每个检查项在「合规」列打勾 ☑ 或留空 ☐
2. **不合规处理**：在「备注」列记录问题及修复建议
3. **适用范围**：暴露面收敛类应用插件（含 exposure_auth、exposure_login 等）
4. **特殊场景**：纯防护类插件（如官网只允许 GET）可跳过 5.3、5.4 等登录相关项

---

## 十、参考示例

- **完整参考**：`examples/grafana.json`
- **简化参考**：`examples/gitlab_config.json`、`examples/confluence.tiger-sec.cn_config.json`

---

## 十一、JSON Schema 与校验脚本

### plugin-config.schema.json

JSON Schema 文件，用于校验插件配置的**结构**是否符合规范。支持：

- IDE 自动补全与实时校验
- `ajv`、`jsonschema` 等工具校验

```bash
# 使用 ajv（Node.js）
npx ajv validate -s plugin-config.schema.json -d examples/gitlab_config.json

# 使用 Python jsonschema
python -c "
import json, jsonschema
schema = json.load(open('plugin-config.schema.json'))
data = json.load(open('examples/gitlab_config.json'))
jsonschema.validate(data, schema)
print('OK')
"
```

### plugin-validate.py / plugin-validate.js

校验脚本，在 Schema 基础上增加**业务规则**校验：

- 插件执行顺序（uri_blocker、request_blocker、uri_bypass 在 exposure_auth 之前）
- 禁止项（regex_whiteuri、plugin_groups、exposure_session/exposure_user 在主 plugins）

```bash
python plugin-validate.py examples/gitlab_config.json
node plugin-validate.js examples/gitlab_config.json
```

**说明**：Schema 无法表达插件顺序等跨字段约束，需通过校验脚本完成。
