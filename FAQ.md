# WEBéšèº«ç›¾é›¶æ”¹é€ å¼•æ“è§„åˆ™ - å¸¸è§é—®é¢˜ FAQ

## ğŸ“‹ ç›®å½•

- [ä¸€ã€åŸºç¡€æ¦‚å¿µé—®é¢˜](#ä¸€åŸºç¡€æ¦‚å¿µé—®é¢˜)
- [äºŒã€é…ç½®ç›¸å…³é—®é¢˜](#äºŒé…ç½®ç›¸å…³é—®é¢˜)
- [ä¸‰ã€å˜é‡ä½¿ç”¨é—®é¢˜](#ä¸‰å˜é‡ä½¿ç”¨é—®é¢˜)
- [å››ã€ä»£ç æ’ä»¶æ‰§è¡Œæµç¨‹é—®é¢˜](#å››ä»£ç æ’ä»¶æ‰§è¡Œæµç¨‹é—®é¢˜)
- [äº”ã€ç™»å½•ç›¸å…³é—®é¢˜](#äº”ç™»å½•ç›¸å…³é—®é¢˜)
- [å…­ã€è®¤è¯ç›¸å…³é—®é¢˜](#å…­è®¤è¯ç›¸å…³é—®é¢˜)
- [ä¸ƒã€æ€§èƒ½ä¼˜åŒ–é—®é¢˜](#ä¸ƒæ€§èƒ½ä¼˜åŒ–é—®é¢˜)
- [å…«ã€é”™è¯¯æ’æŸ¥é—®é¢˜](#å…«é”™è¯¯æ’æŸ¥é—®é¢˜)
- [ä¹ã€æœ€ä½³å®è·µé—®é¢˜](#ä¹æœ€ä½³å®è·µé—®é¢˜)

---

## ä¸€ã€åŸºç¡€æ¦‚å¿µé—®é¢˜

### Q1.1 ä»€ä¹ˆæ˜¯é›¶æ”¹é€ å¼•æ“è§„åˆ™ï¼Ÿä»€ä¹ˆæ—¶å€™ä½¿ç”¨ï¼Ÿ

**A:** é›¶æ”¹é€ å¼•æ“è§„åˆ™æ˜¯WEBéšèº«ç›¾é’ˆå¯¹æš´éœ²é¢æ”¶æ•›åœºæ™¯çš„æ’ä»¶é…ç½®æ–¹æ¡ˆï¼Œé€šè¿‡é€‚é…åº”ç”¨çš„è®¤è¯æœºåˆ¶ï¼Œå®ç°åº”ç”¨é›¶æ”¹é€ çš„æš´éœ²é¢æ”¶æ•›ã€‚

**é€‚ç”¨åœºæ™¯ï¼š**
- âœ… ä¼ä¸šå†…éƒ¨åº”ç”¨ï¼ˆOA/ERP/è´¢åŠ¡/CRMç­‰ï¼‰éœ€è¦æš´éœ²é¢æ”¶æ•›
- âœ… å¸Œæœ›åœ¨ä¸ä¿®æ”¹åº”ç”¨ä»£ç çš„æƒ…å†µä¸‹ï¼Œå®ç°æš´éœ²é¢æ”¶æ•›
- âœ… éœ€è¦å¼±å¯†ç å®æ—¶æ‹¦æˆªå’Œæš´åŠ›ç ´è§£é˜²æŠ¤
- âœ… éœ€è¦éšè—åç«¯æœåŠ¡æ¥å£ï¼Œé™ä½è¢«æ‰«æé£é™©

**ä¸é€‚åˆçš„åœºæ™¯ï¼š**
- âŒ çº¯é™æ€ç½‘ç«™ï¼ˆæ— éœ€è®¤è¯ï¼‰
- âŒ éœ€è¦æ·±åº¦å®šåˆ¶è®¤è¯æµç¨‹ä¸”æ— æ³•é€šè¿‡é…ç½®å®ç°

### Q1.2 å››ä¸ªæ ¸å¿ƒæ¨¡å—çš„ä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿ

**A:** å››ä¸ªæ ¸å¿ƒæ¨¡å—åŠå…¶ä½œç”¨ï¼š

| æ¨¡å— | ä½œç”¨ | ä¸€å¥è¯è¯´æ˜ |
|------|------|-----------|
| `exposure_auth` | è®¤è¯æ¨¡å— | æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²ç™»å½•ï¼Œæœªç™»å½•åˆ™æ‹¦æˆªæˆ–é‡å®šå‘ |
| `exposure_login` | ç™»å½•æ¨¡å— | Hook ç™»å½•æ¥å£ï¼Œåˆ¤å®šç™»å½•æˆåŠŸ/å¤±è´¥ï¼Œæ”¯æŒå¯†ç ç­–ç•¥ |
| `exposure_user` | ç”¨æˆ·ä¿¡æ¯æ¨¡å— | é€šè¿‡å­è¯·æ±‚è·å–ç”¨æˆ·èº«ä»½ä¿¡æ¯ï¼ˆuser_idã€user_nameï¼‰ |
| `exposure_session` | ä¼šè¯å¤„ç†æ¨¡å— | å®šä¹‰å¦‚ä½•å¤„ç†ä¼šè¯ï¼ˆWISID cookieï¼‰ |

### Q1.3 ä»£ç æ’ä»¶å’Œåº”ç”¨æ’ä»¶æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ

**A:** ä»£ç æ’ä»¶å’Œåº”ç”¨æ’ä»¶æ˜¯ä¸¤ä¸ªä¸åŒå±‚æ¬¡çš„æ¦‚å¿µï¼š

**ä»£ç æ’ä»¶ï¼ˆæ’ä»¶å¼•æ“ï¼‰**ï¼š
- **å®šä¹‰**ï¼šå•ä¸ª Lua æ–‡ä»¶æ¨¡å—ï¼ˆå¦‚ `exposure_login.lua`ã€`passwd_restriction.lua` ç­‰ï¼‰
- **ä½ç½®**ï¼šä½äº `shield/plugins/` ç›®å½•ä¸‹
- **ä½œç”¨**ï¼šå®ç°å…·ä½“çš„ä¸šåŠ¡é€»è¾‘ï¼ˆå¦‚ç™»å½•å¤„ç†ã€å¼±å¯†ç æ£€æµ‹ã€æš´åŠ›ç ´è§£é˜²æŠ¤ç­‰ï¼‰
- **é…ç½®**ï¼šæ¯ä¸ªä»£ç æ’ä»¶æ¥æ”¶ä¸€ä»½ JSON é…ç½®å¯¹è±¡ï¼ˆ`conf`ï¼‰ï¼Œç”¨äºæ§åˆ¶æ’ä»¶çš„è¡Œä¸º

**åº”ç”¨æ’ä»¶**ï¼š
- **å®šä¹‰**ï¼šå°†ä¸€ä¸ªåº”ç”¨ç”¨åˆ°çš„æ‰€æœ‰ä»£ç æ’ä»¶çš„ JSON é…ç½®é›†åˆ
- **ä½œç”¨**ï¼šç»Ÿä¸€ç®¡ç†ä¸€ä¸ªåº”ç”¨çš„æ‰€æœ‰ä»£ç æ’ä»¶é…ç½®ï¼Œä¾¿äºé…ç½®ç®¡ç†å’Œ UI åŒ–æ“ä½œ
- **æ ¼å¼**ï¼šåŒ…å« `desc`ã€`user_configures`ã€`gw_configures` ä¸‰ä¸ªä¸»è¦éƒ¨åˆ†
- **ç¤ºä¾‹**ï¼š`grafanaæ’ä»¶.json` å°±æ˜¯ Grafana åº”ç”¨çš„åº”ç”¨æ’ä»¶

**å…³ç³»**ï¼š
```
åº”ç”¨æ’ä»¶ (grafanaæ’ä»¶.json)
    â””â”€ gw_configures (å®é™…ä¸‹å‘ç»™ç½‘å…³çš„é…ç½®)
        â””â”€ plugin_confs (ä»£ç æ’ä»¶é…ç½®)
            â””â”€ ä¸‹å‘ç»™å„ä¸ªä»£ç æ’ä»¶
                â”œâ”€ exposure_login.lua â† exposure_login é…ç½®
                â”œâ”€ passwd_restriction.lua â† passwd_restriction é…ç½®
                â””â”€ ...
```

**è¯¦ç»†è¯´æ˜è§ï¼š** [åº”ç”¨æ’ä»¶æ–‡æ¡£.md](åº”ç”¨æ’ä»¶æ–‡æ¡£.md)

### Q1.4 ä»£ç æ’ä»¶é…ç½®çš„ä¼˜å…ˆçº§æ˜¯ä»€ä¹ˆï¼Ÿ

**A:** ä»£ç æ’ä»¶é…ç½®ä¼˜å…ˆçº§ï¼ˆä»é«˜åˆ°ä½ï¼‰ï¼š

```
æ’ä»¶ç»„å†…çš„ä»£ç æ’ä»¶é…ç½® > åº”ç”¨è®¾ç½®çš„ä»£ç æ’ä»¶é…ç½® > ç³»ç»Ÿè®¾ç½®çš„å…¨å±€ä»£ç æ’ä»¶é…ç½®
```

å³ï¼š**å±€éƒ¨æ’ä»¶ç»„é…ç½® > åº”ç”¨ä½œç”¨åŸŸé…ç½® > å…¨å±€ä½œç”¨åŸŸé…ç½®**

**ç¤ºä¾‹ï¼š**
```json
{
  "plugins": [
    "exposure_auth",  // ä½¿ç”¨ plugin_confs æˆ–å…¨å±€é…ç½®
    {
      "name": "exposure_auth",
      "conf": {...}   // å†…è”é…ç½®ï¼Œä¼˜å…ˆçº§æœ€é«˜
    }
  ]
}
```

---

## äºŒã€é…ç½®ç›¸å…³é—®é¢˜

### Q2.1 å¦‚ä½•é…ç½®ä»£ç æ’ä»¶ï¼Ÿå­—ç¬¦ä¸²æ ¼å¼å’Œå¯¹è±¡æ ¼å¼æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ

**A:** `plugins` æ•°ç»„æ”¯æŒä¸¤ç§æ ¼å¼ï¼š

**æ ¼å¼1ï¼šå­—ç¬¦ä¸²æ ¼å¼**
```json
{
  "plugins": ["exposure_auth", "exposure_session"]
}
```
- é…ç½®æŸ¥æ‰¾é¡ºåºï¼š`plugin_confs[plugin_name]` â†’ å…¨å±€é»˜è®¤é…ç½®

**æ ¼å¼2ï¼šå¯¹è±¡æ ¼å¼ï¼ˆå†…è”é…ç½®ï¼‰**
```json
{
  "plugins": [
    {
      "name": "exposure_auth",
      "conf": {
        "response_code": 403,
        "response_msg": "æ‹’ç»è®¿é—®"
      }
    }
  ]
}
```
- ç›´æ¥ä½¿ç”¨ `conf` ä¸­çš„é…ç½®ï¼Œä¼˜å…ˆçº§æœ€é«˜

### Q2.2 `exposure_auth` å’Œ `exposure_session` çš„å…³ç³»æ˜¯ä»€ä¹ˆï¼Ÿ

**A:**
- `exposure_auth`ï¼šè´Ÿè´£è®¤è¯æµç¨‹ç¼–æ’ï¼Œæ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²ç™»å½•
- `exposure_session`ï¼šè´Ÿè´£ä¼šè¯ç®¡ç†ï¼ŒéªŒè¯å’Œè®¾ç½® WISID cookie

**é…ç½®è¯´æ˜ï¼š**
- `exposure_auth` ä¸åŒ…å« `key_name` å’Œ `cookie` é…ç½®
- è¿™äº›é…ç½®åœ¨ `exposure_session` ä»£ç æ’ä»¶ä¸­é…ç½®

**é…ç½®ç¤ºä¾‹ï¼š**
```json
{
  "plugins": [
    {
      "name": "exposure_auth",
      "conf": {
        "response_code": 403,
        "response_msg": "æ‹’ç»è®¿é—®"
      }
    },
    {
      "name": "exposure_session",
      "conf": {
        "key_name": "cookie_WISID",
        "cookie": {
          "expires": 86400,
          "path": "/"
        }
      }
    }
  ]
}
```

### Q2.3 `exposure_user` çš„ `key_name` æ˜¯ä»€ä¹ˆï¼Ÿå¦‚ä½•é…ç½®ï¼Ÿ

**A:** `key_name` ç”¨äºï¼š
1. æ£€æŸ¥è¯·æ±‚ä¸­æ˜¯å¦å­˜åœ¨è¯¥ cookie/header
2. ä½œä¸ºç¼“å­˜keyçš„ä¸€éƒ¨åˆ†ï¼ˆ`IP + key_value`ï¼‰

**é…ç½®ç¤ºä¾‹ï¼š**
```json
{
  "exposure_user": {
    "key_name": "cookie_gitlab_session",  // æ³¨æ„ï¼šcookieåç§°å‰åŠ  cookie_ï¼Œä¸‹åˆ’çº¿éœ€è¦è½¬ä¹‰
    "sub_requests": [...]
  }
}
```

**å¸¸è§é”™è¯¯ï¼š**
- âŒ `"key_name": "$cookie_session"` - ä¸éœ€è¦ `$` å‰ç¼€
- âŒ `"key_name": "cookie_gitlab_session"` - å¦‚æœcookieåç§°æ˜¯ `_gitlab_session`ï¼Œéœ€è¦å†™æˆ `cookie__gitlab_session`
- âœ… `"key_name": "cookie_gitlab_session"` - æ­£ç¡®æ ¼å¼

### Q2.4 å¦‚ä½•é…ç½®ç™½åå•ï¼Ÿ`uri_bypass` å’Œå­è·¯ç”±ç™½åå•æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ

**A:** æ”¯æŒä¸¤ç§ç™½åå•æ–¹å¼ï¼š

**æ–¹å¼1ï¼šå­è·¯ç”±ç™½åå•ï¼ˆæ¨èï¼Œæ€§èƒ½æ›´é«˜ï¼‰**
```json
{
  "sub_routes": [{
    "name": "static_resources",
    "plugins": [],  // ç©ºæ•°ç»„è¡¨ç¤ºè·³è¿‡æ‰€æœ‰ä»£ç æ’ä»¶
    "routes": [
      {"uri": "/health", "methods": ["GET"]},
      {"uri": "/static/*"},
      {"uri": "/assets/*"}
    ]
  }]
}
```
- **æ€§èƒ½**ï¼šåŸºæ•°æ ‘åŒ¹é…ï¼ŒO(k) å¤æ‚åº¦ï¼Œæ€§èƒ½æ›´é«˜
- **æ”¯æŒ**ï¼šHTTPæ–¹æ³•åŒ¹é…ã€æ¡ä»¶åŒ¹é…ï¼ˆvarsï¼‰

**æ–¹å¼2ï¼šæ­£åˆ™ç™½åå•ï¼ˆuri_bypassï¼‰**
```json
{
  "plugins": [
    "uri_bypass",  // å¿…é¡»åœ¨ exposure_auth ä¹‹å‰
    "exposure_auth"
  ],
  "plugin_confs": {
    "uri_bypass": {
      "filters": [
        "^/health$",
        "^/static/.*",
        "\\.(css|js|png|jpg)$"
      ]
    }
  }
}
```
- **æ€§èƒ½**ï¼šæ­£åˆ™åŒ¹é…ï¼Œæ€§èƒ½ä¸€èˆ¬
- **æ”¯æŒ**ï¼šå¤æ‚æ­£åˆ™è¡¨è¾¾å¼
- **æ³¨æ„**ï¼š** `filters` æ˜¯æ­£åˆ™å­—ç¬¦ä¸²æ•°ç»„ï¼Œä¸æ”¯æŒ IP ç»´åº¦æ§åˆ¶ã€‚å¦‚éœ€ IP ç»´åº¦æ§åˆ¶ï¼Œè¯·ä½¿ç”¨ OP å¹³å°é…ç½® `rules`ã€‚

**æ³¨æ„ï¼š** `uri_bypass` å¿…é¡»é…ç½®åœ¨ `exposure_auth` **ä¹‹å‰**ï¼Œå¦åˆ™ç™½åå•ä¸ç”Ÿæ•ˆã€‚

**è¯¦ç»†è¯´æ˜è§ï¼š** [ç™½åå•.md](ç™½åå•.md)

---

## ä¸‰ã€å˜é‡ä½¿ç”¨é—®é¢˜

### Q3.1 å˜é‡æœ‰å“ªå‡ ç±»ï¼Ÿå¦‚ä½•ä½¿ç”¨ï¼Ÿ

**A:** å˜é‡åˆ†ä¸ºä¸‰ç±»ï¼š

**1. WEBéšèº«ç›¾å†…éƒ¨å˜é‡ï¼ˆç³»ç»Ÿå˜é‡ï¼‰**
- æ ¼å¼ï¼š`$å˜é‡å`
- ç¤ºä¾‹ï¼š`$remote_addr`ã€`$http_authorization`ã€`$cookie_WISID`
- ä½¿ç”¨ï¼šåœ¨ `fetch_vars` ä¸­ç›´æ¥å¼•ç”¨ï¼Œæˆ–åœ¨è¡¨è¾¾å¼ä¸­ä½¿ç”¨

**2. fetch_vars å†…éƒ¨å˜é‡ï¼ˆå“åº”å˜é‡ï¼‰**
- æ ¼å¼ï¼š`å˜é‡å` æˆ– `${å˜é‡å}`
- ç¤ºä¾‹ï¼š`upstream_status`ã€`header_content_type`
- ä½¿ç”¨ï¼šåœ¨è¡¨è¾¾å¼ä¸­ä½¿ç”¨ï¼Œå¦‚ `success_expr`

**3. ç”¨æˆ·è‡ªå®šä¹‰å˜é‡**
- æ ¼å¼ï¼š`${å˜é‡å}`
- ç¤ºä¾‹ï¼š`${user_id}`ã€`${get_user.name}`
- ä½¿ç”¨ï¼šé€šè¿‡ `fetch_vars` æå–ï¼Œåœ¨è¡¨è¾¾å¼æˆ–åŠ¨æ€å‚æ•°ä¸­ä½¿ç”¨

**è¯¦ç»†è¯´æ˜è§ï¼š** [å˜é‡åˆ†ç±»è¯´æ˜.md](å˜é‡åˆ†ç±»è¯´æ˜.md)

### Q3.2 å¦‚ä½•å¼•ç”¨å˜é‡ï¼Ÿ`$xxx` å’Œ `${xxx}` æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ

**A:**

**`$xxx` - ç³»ç»Ÿå˜é‡å¼•ç”¨**
```json
{
  "fetch_vars": {
    "client_ip": "$remote_addr",
    "username": "$post_arg_username"
  }
}
```

**`${xxx}` - ç”¨æˆ·è‡ªå®šä¹‰å˜é‡æˆ–å“åº”å˜é‡å¼•ç”¨**
```json
{
  "success_expr": [
    ["${upstream_status}", "==", 200],
    ["${user_id}", "!=", ""]
  ]
}
```

**åœ¨å­è¯·æ±‚ä¸­å¼•ç”¨ï¼š**
```json
{
  "sub_requests": [{
    "name": "check_login",
    "fetch_vars": {
      "session_id": {...}
    }
  }, {
    "name": "get_user",
    "headers": {
      "X-Session-ID": "${check_login.session_id}"  // å¼•ç”¨å‰ä¸€ä¸ªå­è¯·æ±‚çš„å˜é‡
    }
  }]
}
```

### Q3.3 å¦‚ä½•ä» JSON å“åº”ä¸­æå–æ•°æ®ï¼Ÿç®€å•è·¯å¾„å’Œ JSONPath æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ

**A:** æ”¯æŒä¸¤ç§è·¯å¾„æ ¼å¼ï¼š

**1. ç®€å•è·¯å¾„ï¼ˆæ¨èï¼Œè¿”å›ç›´æ¥å€¼ï¼‰**
```json
{
  "fetch_vars": {
    "user_id": {
      "source": "response_body",
      "field": "data.user.id",  // ç‚¹å·åˆ†éš”
      "parser": "json"
    }
  }
}
```
- è¿”å›ï¼šç›´æ¥å€¼ï¼ˆå­—ç¬¦ä¸²ã€æ•°å­—ç­‰ï¼‰
- é€‚ç”¨äºï¼šæå–å•ä¸ªå›ºå®šå­—æ®µ

**2. JSONPathï¼ˆè¿”å›æ•°ç»„ï¼‰**
```json
{
  "fetch_vars": {
    "user_ids": {
      "source": "response_body",
      "field": "$.data.users[*].id",  // JSONPath è¡¨è¾¾å¼
      "parser": "json"
    }
  },
  "user_id_var": "${user_ids}[*]"  // ä»æ•°ç»„ä¸­æå–ç¬¬ä¸€ä¸ªéç©ºå€¼
}
```
- è¿”å›ï¼šæ•°ç»„
- é€‚ç”¨äºï¼šæ•°ç»„éå†ã€æ¡ä»¶è¿‡æ»¤ã€é€’å½’æŸ¥æ‰¾

**è¯¦ç»†è¯´æ˜è§ï¼š** [path-syntax.md](path-syntax.md)

### Q3.4 Cookie å˜é‡åå¦‚ä½•æ­£ç¡®é…ç½®ï¼Ÿ

**A:** Cookie å˜é‡åè§„åˆ™ï¼š

**è§„åˆ™ï¼š**
- Cookie åç§°è½¬æ¢ä¸ºå°å†™
- `-` æ›¿æ¢ä¸º `_`
- Cookie åç§°å‰åŠ  `cookie_` å‰ç¼€

**ç¤ºä¾‹ï¼š**

| Cookie åç§° | å˜é‡å |
|------------|--------|
| `WISID` | `cookie_wisid` |
| `_gitlab_session` | `cookie_gitlab_session`ï¼ˆæ³¨æ„ï¼šä¸‹åˆ’çº¿éœ€è¦è½¬ä¹‰ï¼‰ |
| `JSESSIONID` | `cookie_jsessionid` |
| `X-Auth-Token` | `cookie_x_auth_token` |

**åœ¨ key_name ä¸­ä½¿ç”¨ï¼š**
```json
{
  "exposure_user": {
    "key_name": "cookie_gitlab_session"  // æ³¨æ„ï¼šä¸éœ€è¦ $ å‰ç¼€
  }
}
```

---

## å››ã€ä»£ç æ’ä»¶æ‰§è¡Œæµç¨‹é—®é¢˜

### Q4.1 éç™»å½•å£çš„è®¤è¯æµç¨‹æ˜¯ä»€ä¹ˆï¼Ÿ

**A:** éç™»å½•å£è®¤è¯æµç¨‹ï¼š

```
è¯·æ±‚ â†’ exposure_auth
         â”‚
         â”œâ”€â”€ æœ‰æ•ˆ WISIDï¼ˆè°ƒç”¨exposure_sessionæ£€æµ‹ï¼‰  â†’ æ”¾è¡Œ âœ…
         â”‚
         â””â”€â”€ æ— æœ‰æ•ˆ WISID â†’ exposure_user (è·å–ç”¨æˆ·ä¿¡æ¯)
                              â”‚
                              â”œâ”€â”€ æ˜¯å¦æœ‰key_nameå¯¹åº”çš„key value(cookie/header)
                              â”‚   â”œâ”€â”€ æ²¡æœ‰ â†’ æ ¹æ®exposure_authé…ç½®æ”¾è¡Œ/æ‹’ç»
                              â”‚   â””â”€â”€ æœ‰ â†’ ç»§ç»­
                              â”‚
                              â”œâ”€â”€ æ„å»ºç¼“å­˜key (IP + key_value)
                              â”‚   â”œâ”€â”€ ç¼“å­˜å‘½ä¸­ â†’ è¿”å›ç¼“å­˜ç»“æœ â†’ è®¾ç½®WISID â†’ æ”¾è¡Œ âœ…
                              â”‚   â””â”€â”€ ç¼“å­˜æœªå‘½ä¸­ â†’ ç»§ç»­
                              â”‚
                              â””â”€â”€ å‘èµ·å­è¯·æ±‚ sub_requests
                                  â”œâ”€â”€ é¡ºåºæ‰§è¡Œå­è¯·æ±‚
                                  â”œâ”€â”€ æå–ç”¨æˆ·ä¿¡æ¯
                                  â”œâ”€â”€ ç¼“å­˜ç»“æœ
                                  â”œâ”€â”€ è°ƒç”¨ httpauth.request_WISID
                                  â””â”€â”€ è®¾ç½®WISID â†’ æ”¾è¡Œ âœ…
```

### Q4.2 ç™»å½•å£çš„æ‰§è¡Œæµç¨‹æ˜¯ä»€ä¹ˆï¼Ÿ

**A:** ç™»å½•å£æ‰§è¡Œæµç¨‹ï¼š

```
è¯·æ±‚ â†’ exposure_login
         â”‚
         â”œâ”€â”€ ä»£ç†è½¬å‘ç™»å½•è¯·æ±‚åˆ°åç«¯ (~20-50ms)
         â”œâ”€â”€ æå–å“åº”å˜é‡ (fetch_vars)
         â”œâ”€â”€ åˆ¤å®šç™»å½•æˆåŠŸ (success_expr)
         â”‚   â”œâ”€â”€ å¤±è´¥ â†’ è¿”å›åŸå§‹å“åº”
         â”‚   â””â”€â”€ æˆåŠŸ â†’ ç»§ç»­
         â”‚
         â””â”€â”€ save_session == true?
             â”œâ”€â”€ false â†’ è¿”å›åŸå§‹å“åº”
             â””â”€â”€ true â†’ exposure_session.save()
                 â”œâ”€â”€ è°ƒç”¨ httpauth.request_WISID
                 â””â”€â”€ è®¾ç½®WISID Cookie â†’ è¿”å›å“åº” âœ…
```

### Q4.3 WISID è¶…æ—¶æ€ä¹ˆåŠï¼Ÿ

**A:** WISID è¶…æ—¶ä¼šé‡æ–°èµ°è®¤è¯æµç¨‹ï¼š
1. `exposure_session.check(WISID)` æ£€æµ‹åˆ° WISID æ— æ•ˆ
2. è°ƒç”¨ `exposure_user` é‡æ–°è·å–ç”¨æˆ·ä¿¡æ¯
3. é‡æ–°è®¾ç½® WISID

### Q4.4 ç”¨æˆ·é€€å‡ºç™»å½•åè¿˜èƒ½è®¿é—®éç™»å½•å£å—ï¼Ÿ

**A:** ç›®å‰å¯ä»¥ï¼Œå› ä¸ºï¼š
- ç”¨æˆ·åœ¨åç«¯é€€å‡ºç™»å½•ï¼Œä½† WISID cookie ä»ç„¶æœ‰æ•ˆ
- ç½‘å…³ä¼šç»§ç»­ä½¿ç”¨ WISID è¿›è¡Œè®¤è¯
- å¦‚æœåº”ç”¨éœ€è¦ç«‹å³å¤±æ•ˆï¼Œéœ€è¦æ¸…é™¤ WISID cookie

**è§£å†³æ–¹æ¡ˆï¼š**
- åœ¨åº”ç”¨çš„é€€å‡ºç™»å½•æ¥å£ä¸­ï¼Œæ¸…é™¤ WISID cookie
- æˆ–é…ç½®è¾ƒçŸ­çš„ WISID è¿‡æœŸæ—¶é—´

### Q4.5 ç”¨æˆ·é€€å‡ºç™»å½•åé‡æ–°ç™»å½•ï¼ŒWEBéšèº«ç›¾çš„èº«ä»½ä¼šæ¢æ‰å—ï¼Ÿ

**A:** ä¼šæ­£ç¡®è¯†åˆ«èº«ä»½ï¼š
1. é‡æ–°ç™»å½•æˆåŠŸåï¼Œ`exposure_login` ä¼šè°ƒç”¨ `exposure_session.save()`
2. ä¼šç”Ÿæˆæ–°çš„ WISIDï¼Œæ›¿æ¢æ—§çš„ WISID
3. åç»­è¯·æ±‚ä½¿ç”¨æ–°çš„ WISID è¿›è¡Œè®¤è¯

---

## äº”ã€ç™»å½•ç›¸å…³é—®é¢˜

### Q5.1 å¦‚ä½•é…ç½®ç™»å½•æ¥å£ Hookï¼Ÿ

**A:** é…ç½®æ­¥éª¤ï¼š

**1. åœ¨ `sub_routes` ä¸­é…ç½®ç™»å½•æ¥å£ç™½åå•**
```json
{
  "sub_routes": [{
    "name": "login_standard",
    "desc": "æ ‡å‡†ç™»å½•æ¥å£",
    "plugin_group_id": "login_gid",
    "routes": [{
      "uri": "/api/login",
      "methods": ["POST"]
    }]
  }]
}
```

**2. åœ¨ `plugin_groups` ä¸­é…ç½®ç™»å½•æ’ä»¶é“¾**
```json
{
  "plugin_groups": {
    "login_gid": [
      "passwd_restriction",
      {
        "name": "exposure_login",
        "conf": {
          "fetch_vars": {
            "user_id": {
              "source": "response_body",
              "field": "data.user.id",
              "parser": "json"
            }
          },
          "user_id_var": "${user_id}",
          "success_expr": [
            ["${upstream_status}", "==", 200],
            ["${user_id}", "!=", ""]
          ],
          "save_session": true  // é‡è¦ï¼šå¿…é¡»é…ç½®ä¸º true
        }
      }
    ]
  }
}
```

### Q5.2 `save_session` ä»€ä¹ˆæ—¶å€™è®¾ç½®ä¸º `true`ï¼Œä»€ä¹ˆæ—¶å€™è®¾ç½®ä¸º `false`ï¼Ÿ

**A:**

**`save_session: true`ï¼ˆé»˜è®¤æ¨èï¼‰**
- ç™»å½•è¯·æ±‚æˆåŠŸåï¼Œç«‹å³ä¿å­˜ä¼šè¯ï¼ˆè®¾ç½® WISID cookieï¼‰
- é€‚ç”¨äºï¼šå¤§å¤šæ•°åº”ç”¨ï¼Œç™»å½•æˆåŠŸå³ä¼šè¯æœ‰æ•ˆ

**`save_session: false`**
- ç™»å½•è¯·æ±‚æˆåŠŸåï¼Œä¸ä¿å­˜ä¼šè¯
- é€‚ç”¨äºï¼šç‰¹æ®Šåœºæ™¯ï¼Œå¦‚æ³›å¾®V10
  - ç™»å½•è¯·æ±‚æˆåŠŸï¼Œä½†ä¼šè¯åœ¨åç»­è¯·æ±‚æ‰æ­£å¼ç”Ÿæ•ˆ
  - éœ€è¦ç­‰å¾…åº”ç”¨è®¾ç½®ä¼šè¯ cookie åï¼Œå†ä¿å­˜ WISID

### Q5.3 å¦‚ä½•åˆ¤å®šç™»å½•æˆåŠŸï¼Ÿ`success_expr` å¦‚ä½•é…ç½®ï¼Ÿ

**A:** `success_expr` ä½¿ç”¨ `lua-resty-expr` è¡¨è¾¾å¼è¯­æ³•ï¼š

**ç¤ºä¾‹1ï¼šHTTP 2xx æˆåŠŸ**
```json
{
  "success_expr": [
    ["${upstream_status}", ">=", 200],
    ["${upstream_status}", "<", 300]
  ]
}
```

**ç¤ºä¾‹2ï¼šçŠ¶æ€ç 200ä¸”è¿”å›ç”¨æˆ·ID**
```json
{
  "success_expr": ["AND",
    ["${upstream_status}", "==", 200],
    ["${user_id}", "!=", ""]
  ]
}
```

**ç¤ºä¾‹3ï¼šGitLab ç™»å½•ï¼ˆ302é‡å®šå‘ä¸”åŒ…å«session cookieï¼‰**
```json
{
  "fetch_vars": {
    "set_cookie": {
      "source": "response_header",
      "field": "Set-Cookie"
    }
  },
  "success_expr": ["AND",
    ["${upstream_status}", "==", 302],
    ["${set_cookie}", "~", "_gitlab_session"]
  ]
}
```

**è¯¦ç»†è¯­æ³•è§ï¼š** [lua-resty-expr.md](lua-resty-expr.md)

### Q5.4 å¦‚ä½•åˆ¤å®šè´¦å¯†ç™»å½•å¤±è´¥ï¼Ÿ`passwd_failed_expr` å¦‚ä½•é…ç½®ï¼Ÿ

**A:** `passwd_failed_expr` ç”¨äºæ ‡è®°æš´åŠ›ç ´è§£è®¡æ•°ï¼š

```json
{
  "passwd_failed_expr": ["AND",
    ["${upstream_status}", "==", 401],
    ["${error_code}", "==", "INVALID_PASSWORD"]
  ]
}
```

**æ³¨æ„ï¼š** åªæœ‰é…ç½®äº† `passwd_failed_expr`ï¼Œ`passwd_bruteforce` ä»£ç æ’ä»¶æ‰èƒ½æ­£ç¡®è®¡æ•°ã€‚

### Q5.5 ç™»å½•æ¥å£ä¹Ÿè¢«æ‹¦æˆªäº†æ€ä¹ˆåŠï¼Ÿ

**A:** æ£€æŸ¥ä»¥ä¸‹å‡ ç‚¹ï¼š

1. **å­è·¯ç”±æœ¬èº«å°±æ˜¯ç™½åå•è·¯å¾„ï¼Œæ‰€ä»¥ç™»å½•æ¥å£çš„URLä¹Ÿæ˜¯ç™½åå•çš„**
  *æ‰€ä»¥æ— éœ€é¢å¤–å†è®¾ç½®urlç™½åå•*

   ```json
   {
     "sub_routes": [{
       "name": "login",
       "plugin_group_id": "login_gid",
       "routes": [{
         "uri": "/api/login",  // ç¡®è®¤URIæ­£ç¡®
         "methods": ["POST"]   // ç¡®è®¤æ–¹æ³•æ­£ç¡®
       }]
     }]
   }
   ```


---

## å…­ã€è®¤è¯ç›¸å…³é—®é¢˜

### Q6.1 è¿”å› 403 ä½†ç”¨æˆ·å·²ç™»å½•ï¼Œæ€ä¹ˆåŠï¼Ÿ

**A:** æ’æŸ¥æ­¥éª¤ï¼š

1. **æ£€æŸ¥ `exposure_user` é…ç½®**
   - `key_name` æ˜¯å¦æ­£ç¡®ï¼ˆæ³¨æ„ä¸‹åˆ’çº¿è½¬ä¹‰ï¼‰
   - `uri` æ˜¯å¦æŒ‡å‘æ­£ç¡®çš„ç”¨æˆ·ä¿¡æ¯æ¥å£
   - `field` è·¯å¾„æ˜¯å¦æ­£ç¡®

2. **æ£€æŸ¥ `success_expr` æ¡ä»¶**
   - å“åº”çŠ¶æ€ç æ˜¯å¦åŒ¹é…
   - æå–çš„å˜é‡æ˜¯å¦éç©º

3. **æ£€æŸ¥åº”ç”¨ cookie/header**
   - ä½¿ç”¨æµè§ˆå™¨å¼€å‘è€…å·¥å…·æ£€æŸ¥è¯·æ±‚ä¸­æ˜¯å¦åŒ…å«åº”ç”¨ cookie
   - ç¡®è®¤ cookie åç§°ä¸ `key_name` é…ç½®ä¸€è‡´

4. **æŸ¥çœ‹æ—¥å¿—**
   - æ£€æŸ¥ç½‘å…³æ—¥å¿—ï¼ŒæŸ¥çœ‹å­è¯·æ±‚æ˜¯å¦æˆåŠŸ
   - æ£€æŸ¥æå–çš„å˜é‡å€¼

### Q6.2 `exposure_user` çš„å­è¯·æ±‚å¤±è´¥æ€ä¹ˆåŠï¼Ÿ

**A:** å­è¯·æ±‚å¤±è´¥ä¼šå¯¼è‡´æ•´ä¸ªè®¤è¯æµç¨‹å¤±è´¥ï¼š

æµç¨‹è®¤è¯å¤±è´¥å°±ä¸ä¼šè®¾ç½®user_id_varå’Œ user_name_var



### Q6.3 å¦‚ä½•é…ç½®æœªè®¤è¯è¯·æ±‚çš„å¤„ç†æ–¹å¼ï¼Ÿ

**A:** é€šè¿‡ `exposure_auth` é…ç½®ï¼ˆåœ¨ `plugin_confs` ä¸­ï¼‰ï¼š

**æ–¹å¼1ï¼šè¿”å› 403**
```json
{
  "plugin_confs": {
    "exposure_auth": {
      "reject_unauthed": true,
      "response_code": 403,
      "response_msg": "æ‹’ç»è®¿é—®"
    }
  }
}
```

**æ–¹å¼2ï¼šé‡å®šå‘åˆ°ç™»å½•é¡µ**
```json
{
  "plugin_confs": {
    "exposure_auth": {
      "reject_unauthed": true,
      "response_code": 302,
      "response_headers": {
        "Location": "https://login.example.com?redirect=$request_uri"
      }
    }
  }
}
```

**æ–¹å¼3ï¼šè¿”å› JSON**
```json
{
  "plugin_confs": {
    "exposure_auth": {
      "reject_unauthed": true,
      "response_code": 401,
      "response_headers": {
        "Content-Type": "application/json"
      },
      "response_body": "{\"code\":401,\"message\":\"Unauthorized\"}"
    }
  }
}
```

**æ–¹å¼4ï¼šä»…è®°å½•æ—¥å¿—ï¼Œä¸æ‹¦æˆª**
```json
{
  "plugin_confs": {
    "exposure_auth": {
      "log_unauthed": true
      // ä¸é…ç½® reject_unauthed å’Œ response_codeï¼Œè¡¨ç¤ºæ”¾è¡Œ
    }
  }
}
```

**æ³¨æ„**ï¼š
- `reject_unauthed: true` è¡¨ç¤ºé˜»æ–­æœªè®¤è¯è¯·æ±‚ï¼Œéœ€è¦é…åˆ `response_code` ä½¿ç”¨
- `log_unauthed: true` è¡¨ç¤ºè®°å½•æœªè®¤è¯è¯·æ±‚çš„æ—¥å¿—ï¼Œä½†ä¸é˜»æ–­
- å¦‚æœéƒ½ä¸é…ç½®ï¼Œé»˜è®¤æ”¾è¡Œæœªè®¤è¯è¯·æ±‚

### Q6.4 ä½¿ç”¨åº”ç”¨è‡ªèº« cookie ä½œä¸ºè®¤è¯å‡­æ®ï¼Œå¦‚ä½•é…ç½®ï¼Ÿ

**A:** é…ç½®æ­¥éª¤ï¼š

**1. é…ç½® `exposure_session` ä½¿ç”¨åº”ç”¨ cookie**
```json
{
  "plugin_confs": {
    "exposure_session": {
      "key_name": "cookie_JSESSIONID"  // åº”ç”¨è‡ªèº«çš„ cookie
    }
  }
}
```

**2. é…ç½® `exposure_user` ä½¿ç”¨ç›¸åŒçš„ key_name**
```json
{
  "plugin_confs": {
    "exposure_user": {
      "key_name": "cookie_JSESSIONID",
      "sub_requests": [...]
    }
  }
}
```

**æ³¨æ„ï¼š**
- ä½¿ç”¨åº”ç”¨è‡ªèº« cookie æ—¶ï¼Œ`exposure_session` **ä¸ä¼š** set-cookie
- åªç”¨äºè®¤è¯åˆ¤æ–­ï¼Œä¸ç®¡ç† cookie ç”Ÿå‘½å‘¨æœŸ
- åº”ç”¨éœ€è¦è‡ªå·±ç®¡ç† cookie çš„è¿‡æœŸæ—¶é—´

### Q6.5 exposure_userå’Œexposure_loginä¸­æ˜ç¡®å–ä¸åˆ°åº”ç”¨çš„ç”¨æˆ·è´¦å·ä¿¡æ¯æ€ä¹ˆåŠï¼Ÿ
    å½“å†exposure_userå’Œexposure_loginè¯·æ±‚çš„æ—¶å€™ï¼Œæ˜ç¡®ä¸èƒ½è·å¾—user_idå’Œuser_nameçš„æ—¶å€™ï¼Œç›´æ¥å¯¹å˜é‡è¿›è¡Œå¸¸é‡è®¾ç½®ã€‚
  ```json

  "user_id_var": "unknown",
  "user_name_var": "anonymous"


  ```
---

## ä¸ƒã€æ€§èƒ½ä¼˜åŒ–é—®é¢˜

### Q7.1 å¦‚ä½•ä¼˜åŒ– `uri_bypass` çš„æ€§èƒ½ï¼Ÿ

**A:** ä¼˜åŒ–å»ºè®®ï¼š

1. **ä¼˜åŒ–è§„åˆ™é¡ºåº**
   - å°†ç²¾ç¡®åŒ¹é…è§„åˆ™æ”¾åœ¨å‰é¢ï¼ˆå¦‚ `^/health$`ï¼‰
   - å°†å¤æ‚æ­£åˆ™æ”¾åœ¨åé¢ï¼ˆå¦‚ `\\.(css|js|png)$`ï¼‰

2. **ä½¿ç”¨å­è·¯ç”±ç™½åå•ï¼ˆæ¨èï¼‰**
   - æ€§èƒ½æå‡ 3-5 å€
   - ä½¿ç”¨åŸºæ•°æ ‘åŒ¹é…ï¼ŒO(k) å¤æ‚åº¦

3. **å‡å°‘è§„åˆ™æ•°é‡**
   - åˆå¹¶ç›¸ä¼¼è§„åˆ™
   - ä½¿ç”¨é€šé…ç¬¦åŒ¹é…

**ç¤ºä¾‹ï¼š**
```json
{
  "uri_bypass": {
    "filters": [
      "^/health$",           // ç²¾ç¡®åŒ¹é…ï¼Œæœ€å¿«
      "^/ping$",            // ç²¾ç¡®åŒ¹é…ï¼Œæœ€å¿«
      "^/assets/",          // å‰ç¼€åŒ¹é…ï¼Œè¾ƒå¿«
      "^/static/.*\\.(css|js|png|jpg)$"  // å¤æ‚åŒ¹é…ï¼Œæ”¾æœ€å
    ]
  }
}
```

### Q7.2 å¦‚ä½•æå‡å·²è®¤è¯ç”¨æˆ·çš„æ€§èƒ½ï¼Ÿ

**A:** å·²è®¤è¯ç”¨æˆ·æ€§èƒ½å·²ç»å¾ˆå¥½ï¼ˆQPS 8,000-10,000ï¼‰ï¼Œä¸»è¦ä¼˜åŒ–ç‚¹ï¼š

1. **å‡å°‘ä»£ç æ’ä»¶æ•°é‡**
   - ç§»é™¤ä¸å¿…è¦çš„ä»£ç æ’ä»¶
   - ä¼˜åŒ–ä»£ç æ’ä»¶æ‰§è¡Œé¡ºåº

2. **ä¼˜åŒ–ç™½åå•è§„åˆ™**
   - ä½¿ç”¨å­è·¯ç”±ç™½åå•æ›¿ä»£ `uri_bypass`
   - å‡å°‘æ­£åˆ™åŒ¹é…å¼€é”€

3. **ç¼“å­˜ä¼˜åŒ–**
   - ç¡®ä¿ WISID ç¼“å­˜æœ‰æ•ˆ
   - é…ç½®åˆç†çš„ç¼“å­˜è¿‡æœŸæ—¶é—´

---

## å…«ã€é”™è¯¯æ’æŸ¥é—®é¢˜

### Q8.1 å¦‚ä½•æ’æŸ¥é…ç½®é”™è¯¯ï¼Ÿ

**A:** æ’æŸ¥æ­¥éª¤ï¼š

1. **æ£€æŸ¥ JSON è¯­æ³•**
   - ä½¿ç”¨ JSON éªŒè¯å·¥å…·æ£€æŸ¥è¯­æ³•
   - æ£€æŸ¥å¼•å·ã€é€—å·ã€æ‹¬å·æ˜¯å¦åŒ¹é…

2. **æ£€æŸ¥å¿…å¡«å­—æ®µ**
   - `exposure_user.sub_requests[].name` - å¿…é¡»å”¯ä¸€
   - `exposure_user.sub_requests[].uri` - å¿…é¡»é…ç½®
   - `exposure_user.sub_requests[].success_expr` - å¿…é¡»é…ç½®

3. **æ£€æŸ¥å˜é‡å¼•ç”¨**
   - ç³»ç»Ÿå˜é‡ä½¿ç”¨ `$å˜é‡å`ï¼ˆå¦‚ `$remote_addr`ï¼‰
   - è‡ªå®šä¹‰å˜é‡ä½¿ç”¨ `${å˜é‡å}`ï¼ˆå¦‚ `${user_id}`ï¼‰
   - å­è¯·æ±‚å˜é‡ä½¿ç”¨ `${å­è¯·æ±‚å.å˜é‡å}`ï¼ˆå¦‚ `${get_user.id}`ï¼‰

4. **æ£€æŸ¥è·¯å¾„æå–**
   - JSON è·¯å¾„æ˜¯å¦æ­£ç¡®ï¼ˆä½¿ç”¨ç‚¹å·æˆ– JSONPathï¼‰
   - å­—æ®µåæ˜¯å¦åŒ¹é…ï¼ˆæ³¨æ„å¤§å°å†™ï¼‰

### Q8.2 å¦‚ä½•è°ƒè¯•å˜é‡æå–ï¼Ÿ

**A:** è°ƒè¯•æ–¹æ³•ï¼š

1. **æŠ“åŒ…éªŒè¯å“åº”æ ¼å¼**
   - ä½¿ç”¨æµè§ˆå™¨å¼€å‘è€…å·¥å…·æˆ–æŠ“åŒ…å·¥å…·
   - ç¡®è®¤å“åº” JSON ç»“æ„
   - ç¡®è®¤å­—æ®µè·¯å¾„

2. **ç®€åŒ–é…ç½®æµ‹è¯•**
   ```json
   {
     "fetch_vars": {
       "raw_response": {
         "source": "response_body",
         "field": ".",  // æå–æ•´ä¸ªå“åº”ï¼ˆä½¿ç”¨ç‚¹å·è¡¨ç¤ºæ ¹å¯¹è±¡ï¼‰
         "parser": "json"
       }
     }
   }
   ```

3. **é€æ­¥æå–**
   - å…ˆæå–é¡¶å±‚å­—æ®µ
   - å†æå–åµŒå¥—å­—æ®µ
   - ç¡®è®¤æ¯ä¸€æ­¥éƒ½èƒ½æ­£ç¡®æå–

4. **æŸ¥çœ‹æ—¥å¿—**
   - æ£€æŸ¥ç½‘å…³æ—¥å¿—ä¸­çš„å˜é‡å€¼
   - ç¡®è®¤æå–çš„å˜é‡æ˜¯å¦ç¬¦åˆé¢„æœŸ

### Q8.3 è¡¨è¾¾å¼ä¸ç”Ÿæ•ˆæ€ä¹ˆåŠï¼Ÿ

**A:** å¸¸è§é—®é¢˜ï¼š

1. **å˜é‡åé”™è¯¯**
   - âŒ `["$user_id", "!=", ""]` - ç³»ç»Ÿå˜é‡ä¸éœ€è¦åœ¨è¡¨è¾¾å¼ä¸­ä½¿ç”¨ `$`
   - âœ… `["${user_id}", "!=", ""]` - è‡ªå®šä¹‰å˜é‡ä½¿ç”¨ `${}`

2. **é€»è¾‘æ“ä½œç¬¦ä½ç½®é”™è¯¯**
   - âŒ `[["${status}", "==", 200], "AND", ["${id}", "!=", ""]]`
   - âœ… `["AND", ["${status}", "==", 200], ["${id}", "!=", ""]]`

3. **å€¼ç±»å‹é”™è¯¯**
   - å­—ç¬¦ä¸²å€¼éœ€è¦å¼•å·ï¼š`["${code}", "==", "200"]`
   - æ•°å­—å€¼ä¸éœ€è¦å¼•å·ï¼š`["${status}", "==", 200]`

4. **å˜é‡æœªå®šä¹‰**
   - ç¡®è®¤å˜é‡åœ¨ `fetch_vars` ä¸­å·²å®šä¹‰
   - ç¡®è®¤å˜é‡åæ‹¼å†™æ­£ç¡®

### Q8.4 é™æ€èµ„æºåŠ è½½å¤±è´¥æ€ä¹ˆåŠï¼Ÿ

**A:** è§£å†³æ–¹æ¡ˆï¼š

1. **é…ç½®ç™½åå•**
   ```json
   {
     "plugins": [
       "uri_bypass",  // å¿…é¡»åœ¨ exposure_auth ä¹‹å‰
       "exposure_auth"
     ],
     "plugin_confs": {
       "uri_bypass": {
         "filters": [
           "^/static/.*",
           "^/assets/.*",
           "\\.(css|js|png|jpg|gif|ico|svg|woff|woff2)$"
         ]
       }
     }
   }
   ```

2. **ä½¿ç”¨å­è·¯ç”±ç™½åå•ï¼ˆæ¨èï¼‰**
   ```json
   {
     "sub_routes": [{
       "name": "static",
       "plugins": [],
       "routes": [
         {"uri": "/static/*"},
         {"uri": "/assets/*"}
       ]
     }]
   }
   ```

3. **æ£€æŸ¥è§„åˆ™é¡ºåº**
   - `uri_bypass` å¿…é¡»åœ¨ `exposure_auth` ä¹‹å‰
   - å¦åˆ™ç™½åå•ä¸ç”Ÿæ•ˆ

---

## ä¹ã€æœ€ä½³å®è·µé—®é¢˜

### Q9.1 é…ç½®çš„æœ€ä½³å®è·µæ˜¯ä»€ä¹ˆï¼Ÿ

**A:** æœ€ä½³å®è·µï¼š

1. **ä½¿ç”¨é…ç½®æ¨¡æ¿**
   - å‚è€ƒ [5åˆ†é’Ÿç¼–å†™åº”ç”¨æ’ä»¶.md](5åˆ†é’Ÿç¼–å†™åº”ç”¨æ’ä»¶.md) ä¸­çš„æ¨¡æ¿
   - æ ¹æ®åº”ç”¨ç±»å‹é€‰æ‹©åˆé€‚çš„æ¨¡æ¿

2. **é€æ­¥é…ç½®**
   - å…ˆé…ç½®æœ€å°åŒ–é…ç½®ï¼ŒéªŒè¯åŸºæœ¬åŠŸèƒ½
   - å†é€æ­¥æ·»åŠ å…¶ä»–åŠŸèƒ½

3. **ä½¿ç”¨é…ç½®ç”Ÿæˆå·¥å…·**
   - ä½¿ç”¨ `auto_config_generator.py` è‡ªåŠ¨ç”Ÿæˆé…ç½®
   - åŸºäºæŠ“åŒ…æ–‡ä»¶åˆ†æç”Ÿæˆé…ç½®

4. **é…ç½®éªŒè¯**
   - ä½¿ç”¨ JSON éªŒè¯å·¥å…·æ£€æŸ¥è¯­æ³•
   - ä½¿ç”¨æµ‹è¯•ç”¨ä¾‹éªŒè¯åŠŸèƒ½

### Q9.2 å¦‚ä½•ä¼˜åŒ–æ­£åˆ™è¡¨è¾¾å¼æ€§èƒ½ï¼Ÿ

**A:** ä¼˜åŒ–å»ºè®®ï¼š

1. **ä½¿ç”¨é”šç‚¹**
   - âœ… `^/api/` - ä½¿ç”¨ `^` é”šç‚¹
   - âŒ `/api/` - ä¸ä½¿ç”¨é”šç‚¹

2. **é¿å…è´ªå©ªåŒ¹é…**
   - âœ… `user_id[=:]\\s*([0-9]+)` - å…·ä½“åŒ¹é…
   - âŒ `user_id.*([0-9]+)` - è´ªå©ªåŒ¹é…

3. **ä½¿ç”¨å­—ç¬¦ç±»**
   - âœ… `[0-9]+` - å­—ç¬¦ç±»
   - âŒ `(0|1|2|3|4|5|6|7|8|9)+` - äº¤æ›¿

4. **é¿å…å¤æ‚åµŒå¥—**
   - ç®€åŒ–æ­£åˆ™è¡¨è¾¾å¼
   - ä½¿ç”¨å¤šä¸ªç®€å•æ­£åˆ™æ›¿ä»£ä¸€ä¸ªå¤æ‚æ­£åˆ™

**è¯¦ç»†è¯´æ˜è§ï¼š** [æ­£åˆ™è¡¨è¾¾å¼æ€§èƒ½ä¼˜åŒ–æŒ‡å—.md](æ­£åˆ™è¡¨è¾¾å¼æ€§èƒ½ä¼˜åŒ–æŒ‡å—.md)

### Q9.3 å¦‚ä½•é€‰æ‹© JSON è·¯å¾„æ ¼å¼ï¼Ÿ

**A:** é€‰æ‹©å»ºè®®ï¼š

| åœºæ™¯ | æ¨èæ ¼å¼ | åŸå›  |
|------|---------|------|
| æå–å•ä¸ªå›ºå®šå­—æ®µ | ç®€å•è·¯å¾„ | æ›´ç®€æ´ï¼Œè¿”å›ç›´æ¥å€¼ |
| æå–æ•°ç»„ä¸­æ‰€æœ‰å…ƒç´ çš„æŸä¸ªå±æ€§ | JSONPath | æ”¯æŒ `[*]` é€šé…ç¬¦ |
| æ¡ä»¶è¿‡æ»¤ | JSONPath | æ”¯æŒ `[?()]` è¿‡æ»¤å™¨ |
| é€’å½’æŸ¥æ‰¾ | JSONPath | æ”¯æŒ `..` é€’å½’ä¸‹é™ |
| ç”¨äºè¡¨è¾¾å¼åˆ¤å®š | ç®€å•è·¯å¾„ | è¿”å›ç›´æ¥å€¼ï¼Œå¯ç”¨äºæ¯”è¾ƒ |

**ç¤ºä¾‹ï¼š**
```json
// ç®€å•è·¯å¾„ - æ¨è
{
  "field": "data.user.id"  // è¿”å›: "12345"
}

// JSONPath - éœ€è¦æå–æ•°ç»„
{
  "field": "$.data.users[*].id",  // è¿”å›: ["12345", "67890"]
  "user_id_var": "${user_ids}[*]"  // æå–ç¬¬ä¸€ä¸ªéç©ºå€¼
}
```

### Q9.4 å¦‚ä½•é…ç½®å¤šä¸ªç™»å½•æ¥å£ï¼Ÿ

**A:** é…ç½®ç¤ºä¾‹ï¼š

```json
{
  "sub_routes": [
    {
      "name": "login_standard",
      "plugin_group_id": "login_gid",
      "routes": [{
        "uri": "/api/login",
        "methods": ["POST"]
      }]
    },
    {
      "name": "login_ldap",
      "plugin_group_id": "login_gid",
      "routes": [{
        "uri": "/api/ldap/callback",
        "methods": ["POST"]
      }]
    }
  ],
  "plugin_groups": {
    "login_gid": [
      "passwd_restriction",
      {
        "name": "exposure_login",
        "conf": {
          // å…±äº«é…ç½®
        }
      }
    ]
  }
}
```

### Q9.5 å¦‚ä½•é…ç½®æ¡ä»¶æ‰§è¡Œçš„å­è¯·æ±‚ï¼Ÿ

**A:** ä½¿ç”¨ `exec_expr` é…ç½®ï¼š

```json
{
  "sub_requests": [
    {
      "name": "web_auth",
      "exec_expr": ["$http_user_agent", "!~", "Mobile"],  // éç§»åŠ¨ç«¯æ‰§è¡Œ
      "uri": "/api/web/check",
      "fetch_vars": {...}
    },
    {
      "name": "mobile_auth",
      "exec_expr": ["$http_user_agent", "~", "Mobile"],  // ç§»åŠ¨ç«¯æ‰§è¡Œ
      "uri": "/api/mobile/check",
      "fetch_vars": {...}
    }
  ],
  "user_id_var": ["${web_auth.user_id}", "${mobile_auth.user_id}"]
}
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [5åˆ†é’Ÿå¿«é€Ÿä¸Šæ‰‹](5åˆ†é’Ÿç¼–å†™åº”ç”¨æ’ä»¶.md) - æ–°æ‰‹ä¸Šè·¯å¿…è¯»
- [åº”ç”¨æ’ä»¶æ–‡æ¡£](åº”ç”¨æ’ä»¶æ–‡æ¡£.md) - åº”ç”¨æ’ä»¶å’Œä»£ç æ’ä»¶æ¦‚å¿µè¯´æ˜
- [å˜é‡åˆ†ç±»è¯´æ˜](å˜é‡.md) - å˜é‡ä½¿ç”¨è¯¦è§£
- [è·¯å¾„æå–è¯­æ³•](path-syntax.md) - JSON/XML è·¯å¾„è¯­æ³•
- [è¡¨è¾¾å¼è¯­æ³•](lua-resty-expr.md) - lua-resty-expr è¯­æ³•
- [ç™½åå•é…ç½®](ç™½åå•.md) - ç™½åå•é…ç½®è¯´æ˜
- [æ­£åˆ™è¡¨è¾¾å¼æ€§èƒ½ä¼˜åŒ–æŒ‡å—](æ­£åˆ™è¡¨è¾¾å¼æ€§èƒ½ä¼˜åŒ–æŒ‡å—.md) - æ­£åˆ™ä¼˜åŒ–å»ºè®®

---

## ğŸ†˜ è·å–å¸®åŠ©

å¦‚æœä»¥ä¸Š FAQ æ— æ³•è§£å†³æ‚¨çš„é—®é¢˜ï¼Œè¯·ï¼š

1. æŸ¥çœ‹ç›¸å…³æ–‡æ¡£çš„"æ³¨æ„äº‹é¡¹"éƒ¨åˆ†
2. æ£€æŸ¥é…ç½®ç¤ºä¾‹æ–‡ä»¶ï¼ˆ`examples/` ç›®å½•ï¼‰
3. æŸ¥çœ‹ç½‘å…³æ—¥å¿—ï¼Œå®šä½å…·ä½“é”™è¯¯
4. è”ç³»æŠ€æœ¯æ”¯æŒå›¢é˜Ÿ

---

**æœ€åæ›´æ–°ï¼š** 2025-12-18

