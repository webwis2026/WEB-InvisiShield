# URI Bypass 插件

URI 白名单策略插件，用于配置 URI 白名单规则，匹配白名单的请求将跳过其他插件的执行。插件支持两种配置方式：`rules`（支持 IP 属性）和 `filters`（仅支持 URI 匹配）。

## 功能特性

- **URI 白名单**：支持正则表达式匹配 URI
- **IP 白名单**：支持配置 IP 白名单，仅允许指定 IP 访问
- **IP 黑名单**：支持配置 IP 黑名单，排除指定 IP
- **IP 地域黑名单**：支持配置 IP 地域黑名单，排除指定地区的 IP
- **两种配置方式**：
  - `rules`：用于 UI 配置的复杂规则，支持 IP 属性
  - `filters`：用于应用适配时填写的固定白名单，不支持 IP

## 配置结构

```json
{
  "rules": [],
  "filters": []
}
```

## 配置字段说明

### rules

- **类型**: `table`
- **默认值**: 未配置
- **说明**: 用于 UI 配置的复杂规则列表，支持 IP 属性。每个规则包含 URI 匹配和可选的 IP 限制。

**规则字段**：

#### name

- **类型**: `string`
- **必需**: 是
- **说明**: 规则名称，用于日志记录。

#### uris

- **类型**: `table`
- **必需**: 是
- **说明**: URI 正则匹配列表，使用 PCRE 正则表达式语法。至少需要配置一个 URI。

#### ip_whitelist

- **类型**: `table`
- **默认值**: 未配置
- **说明**: IP 白名单列表。如果配置了此字段，只有列表中的 IP 才能访问匹配的 URI。支持 IPv4 和 IPv6，支持 CIDR 格式。

**示例**：
```json
{
  "ip_whitelist": [
    "192.168.1.0/24",
    "10.0.0.1",
    "2001:db8::/32"
  ]
}
```

#### ip_blacklist

- **类型**: `table`
- **默认值**: 未配置
- **说明**: IP 黑名单列表。如果配置了此字段，列表中的 IP 将被排除在白名单之外。支持 IPv4 和 IPv6，支持 CIDR 格式。

#### ip_black_areas

- **类型**: `table`
- **默认值**: 未配置
- **说明**: IP 地域黑名单列表。如果配置了此字段，指定地区的 IP 将被排除在白名单之外。

**地域字段**：
- `province` (必需) - 省份名称
- `city` (可选) - 城市名称。如果未配置，表示整个省份

**示例**：
```json
{
  "ip_black_areas": [
    {
      "province": "北京",
      "city": "北京"
    },
    {
      "province": "上海"
    }
  ]
}
```

**规则匹配逻辑**：

1. URI 必须匹配规则中的任一 URI 正则表达式
2. 如果配置了 `ip_blacklist`，IP 不能在黑名单中
3. 如果配置了 `ip_black_areas`，IP 的地域不能在黑名单地区中
4. 如果配置了 `ip_whitelist`，IP 必须在白名单中；如果未配置 `ip_whitelist`，则允许所有 IP（但可能被黑名单排除）

### filters

- **类型**: `table`
- **默认值**: 未配置
- **说明**: 用于应用适配时填写的固定白名单，不支持 IP 属性。直接是正则字符串数组，匹配任一正则的请求将跳过其他插件的执行。

**示例**：
```json
{
  "filters": [
    "^/api/public/.*",
    "^/static/.*",
    "^/favicon\\.ico$"
  ]
}
```

**注意**：
- `filters` 不支持 IP 限制，意味着允许所有 IP 访问匹配的 URI
- `filters` 中的每个元素必须是字符串类型
- 空字符串会被忽略

## 完整配置示例

### 示例 1：仅 URI 白名单（filters）

```json
{
  "filters": [
    "^/api/public/.*",
    "^/static/.*",
    "^/favicon\\.ico$"
  ]
}
```

### 示例 2：URI + IP 白名单（rules）

```json
{
  "rules": [
    {
      "name": "管理后台白名单",
      "uris": [
        "^/admin/.*"
      ],
      "ip_whitelist": [
        "192.168.1.0/24",
        "10.0.0.1"
      ]
    }
  ]
}
```

### 示例 3：URI + IP 黑名单（rules）

```json
{
  "rules": [
    {
      "name": "公开接口白名单",
      "uris": [
        "^/api/public/.*"
      ],
      "ip_blacklist": [
        "192.168.1.100",
        "10.0.0.0/8"
      ]
    }
  ]
}
```

### 示例 4：URI + IP 地域黑名单（rules）

```json
{
  "rules": [
    {
      "name": "内部接口白名单",
      "uris": [
        "^/api/internal/.*"
      ],
      "ip_black_areas": [
        {
          "province": "北京",
          "city": "北京"
        },
        {
          "province": "上海"
        }
      ]
    }
  ]
}
```

### 示例 5：复杂规则（rules）

```json
{
  "rules": [
    {
      "name": "管理后台白名单",
      "uris": [
        "^/admin/.*"
      ],
      "ip_whitelist": [
        "192.168.1.0/24"
      ],
      "ip_blacklist": [
        "192.168.1.100"
      ],
      "ip_black_areas": [
        {
          "province": "北京"
        }
      ]
    }
  ]
}
```

## 工作原理

### 匹配流程

```
请求到达
    ↓
rewrite 阶段
    ├─ 检查是否有 rules 或 filters 配置
    │   └─ 无 → 直接返回
    ├─ 创建或获取匹配器（LRU 缓存）
    ├─ 执行匹配
    │   ├─ URI 匹配
    │   │   └─ 不匹配 → 返回，继续执行其他插件
    │   ├─ IP 黑名单检查
    │   │   └─ 在黑名单中 → 返回，继续执行其他插件
    │   ├─ IP 地域黑名单检查
    │   │   └─ 在黑名单地区中 → 返回，继续执行其他插件
    │   └─ IP 白名单检查
    │       ├─ 配置了白名单且 IP 不在白名单中 → 返回，继续执行其他插件
    │       └─ 匹配成功 → 返回 0，中止其他插件执行
    └─ 返回 0（中止其他插件）或 nil（继续执行其他插件）
```

### 匹配优先级

1. **URI 匹配**：首先检查 URI 是否匹配规则中的任一正则表达式
2. **IP 黑名单**：如果配置了 `ip_blacklist`，检查 IP 是否在黑名单中
3. **IP 地域黑名单**：如果配置了 `ip_black_areas`，检查 IP 的地域是否在黑名单地区中
4. **IP 白名单**：如果配置了 `ip_whitelist`，检查 IP 是否在白名单中

### 中止其他插件

当请求匹配白名单规则时，插件返回 `0`，这会中止其他插件的执行。这意味着：

- 匹配白名单的请求不会经过其他安全插件（如 `uri_blocker`、`request_blocker` 等）
- 匹配白名单的请求不会经过认证插件（如 `exposure_auth`）
- 匹配白名单的请求会直接转发到上游服务

## 使用示例

### 基本使用：静态资源白名单

```json
{
  "filters": [
    "^/static/.*",
    "^/assets/.*",
    "^/favicon\\.ico$"
  ]
}
```

### 管理后台 IP 限制

```json
{
  "rules": [
    {
      "name": "管理后台白名单",
      "uris": [
        "^/admin/.*"
      ],
      "ip_whitelist": [
        "192.168.1.0/24"
      ]
    }
  ]
}
```

## 注意事项

1. **匹配顺序**：`rules` 和 `filters` 按配置顺序匹配，匹配到第一个规则后停止匹配
2. **中止其他插件**：匹配白名单的请求会中止其他插件的执行，请谨慎配置
3. **IP 匹配**：
   - 支持 IPv4 和 IPv6
   - 支持 CIDR 格式（如 `192.168.1.0/24`）
   - IPv6 使用 `libcidr-ffi` 库进行匹配
4. **IP 地域匹配**：
   - 使用 `ip2region` 库进行 IP 地域查询
   - 支持省份和城市级别的匹配
   - 如果 `city` 为 `nil`，表示匹配整个省份
5. **性能优化**：插件使用 LRU 缓存缓存匹配器对象，提升性能
6. **与子路由白名单的区别**：
   - `uri_bypass` 是插件级别的白名单，匹配后中止其他插件执行
   - 子路由白名单是路由级别的白名单，匹配后使用不同的插件组

## 与其他插件的关系

`uri_bypass` 插件通常与其他插件配合使用， 例如

**exposure_auth**：`uri_bypass` 匹配的请求会跳过 `exposure_auth` 的认证


插件在 `rewrite` 阶段执行，优先级较高，匹配后可以中止后续插件的执行。
